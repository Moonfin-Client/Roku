import "pkg:/source/enums/ColorPalette.bs"

namespace detailButtons

    ' Creates a detail button node tree (Group > LayoutGroup > IconContainer + Label).
    ' Returns the fully constructed buttonGroup node. Caller is responsible for
    ' observing focusedChild and appending to the button row / tracking array.
    function createButton(config as object, buttonIndex as integer) as object
        buttonGroup = CreateObject("roSGNode", "Group")
        buttonGroup.id = config.id
        buttonGroup.focusable = true

        layoutGroup = CreateObject("roSGNode", "LayoutGroup")
        layoutGroup.layoutDirection = "vert"
        layoutGroup.horizAlignment = "center"
        layoutGroup.itemSpacings = [8]

        iconContainer = CreateObject("roSGNode", "Group")
        iconContainer.id = config.id + "IconContainer"

        bgRect = CreateObject("roSGNode", "Poster")
        bgRect.uri = "pkg:/images/hd_focus_filled.9.png"
        bgRect.loadDisplayMode = "scaleToFit"
        bgRect.width = 120
        bgRect.height = 96
        bgRect.translation = [0, 0]
        bgRect.blendColor = "#444444"
        bgRect.opacity = 0.6
        bgRect.id = config.id + "Background"
        iconContainer.appendChild(bgRect)

        icon = CreateObject("roSGNode", "Poster")
        icon.uri = config.icon
        icon.width = 64
        icon.height = 64
        icon.translation = [28, 16]
        icon.id = config.id + "Icon"
        iconContainer.appendChild(icon)

        layoutGroup.appendChild(iconContainer)

        label = CreateObject("roSGNode", "Label")
        label.text = config.label
        label.font = "font:SmallestSystemFont"
        label.horizAlign = "center"
        label.vertAlign = "top"
        label.width = 160
        label.wrap = true
        label.maxLines = 2
        label.color = "#CCCCCC"
        label.id = config.id + "Text"
        layoutGroup.appendChild(label)

        buttonGroup.appendChild(layoutGroup)

        buttonGroup.addField("buttonAction", "string", false)
        buttonGroup.buttonAction = config.action
        buttonGroup.addField("buttonIndex", "integer", false)
        buttonGroup.buttonIndex = buttonIndex

        return buttonGroup
    end function

    ' Highlights the button at the given index and unhighlights all others.
    sub highlight(index as integer, buttonGroups as object)
        if index < 0 or index >= buttonGroups.count() then return

        for i = 0 to buttonGroups.count() - 1
            buttonGroup = buttonGroups[i]
            if buttonGroup = invalid then continue for

            bgRect = buttonGroup.findNode(buttonGroup.id + "Background")
            icon = buttonGroup.findNode(buttonGroup.id + "Icon")
            textNode = buttonGroup.findNode(buttonGroup.id + "Text")

            if i = index
                if bgRect <> invalid
                    bgRect.blendColor = "#FFFFFF"
                    bgRect.opacity = 1
                end if
                if icon <> invalid then icon.blendColor = "#000000FF"
                if textNode <> invalid and textNode.hasField("color") then textNode.color = "#FFFFFF"
            else
                if bgRect <> invalid
                    bgRect.blendColor = "#444444"
                    bgRect.opacity = 0.6
                end if
                if icon <> invalid then icon.blendColor = "#FFFFFFFF"
                if textNode <> invalid and textNode.hasField("color") then textNode.color = "#CCCCCC"
            end if
        end for
    end sub

    ' Sets all buttons to the unhighlighted (unfocused) visual state.
    sub unhighlightAll(buttonGroups as object)
        for i = 0 to buttonGroups.count() - 1
            buttonGroup = buttonGroups[i]
            if buttonGroup = invalid then continue for

            bgRect = buttonGroup.findNode(buttonGroup.id + "Background")
            icon = buttonGroup.findNode(buttonGroup.id + "Icon")
            textNode = buttonGroup.findNode(buttonGroup.id + "Text")

            if bgRect <> invalid
                bgRect.blendColor = "#444444"
                bgRect.opacity = 0.6
            end if
            if icon <> invalid then icon.blendColor = "#FFFFFFFF"
            if textNode <> invalid and textNode.hasField("color") then textNode.color = "#CCCCCC"
        end for
    end sub

end namespace
