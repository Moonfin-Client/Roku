import "pkg:/source/api/sdk.bs"
import "pkg:/source/enums/ColorPalette.bs"
import "pkg:/source/enums/KeyCode.bs"
import "pkg:/source/enums/PlaybackMethod.bs"
import "pkg:/source/enums/SettingType.bs"
import "pkg:/source/enums/String.bs"
import "pkg:/source/utils/config.bs"
import "pkg:/source/utils/deviceCapabilities.bs"
import "pkg:/source/utils/JellyseerrUtils.bs"
import "pkg:/source/utils/misc.bs"

sub init()
    m.top.optionsAvailable = false

    m.showSecretMenu = false
    m.keypresses = []
    m.magicKeyPressSequence = [KeyCode.UP, KeyCode.LEFT, KeyCode.REPLAY, KeyCode.REWIND, KeyCode.UP, KeyCode.LEFT, KeyCode.REPLAY, KeyCode.REWIND]

    m.userLocation = []

    m.settingsMenu = m.top.findNode("settingsMenu")
    m.settingsMenu.focusBitmapBlendColor = chainLookupReturn(m.global.session, "user.settings.colorCursor", ColorPalette.HIGHLIGHT)
    m.settingsMenu.focusFootprintBlendColor = ColorPalette.TRANSPARENT
    m.settingsMenu.focusedColor = ColorPalette.WHITE

    testRectangle = m.top.findNode("testRectangle")
    testRectangle.blendColor = ColorPalette.ELEMENTBACKGROUND

    m.settingDesc = m.top.findNode("settingDesc")
    m.path = m.top.findNode("path")

    m.version = m.top.findNode("version")
    drawingStyles = {
        "default": {
            "fontSize": 27,
            "fontUri": "font:SystemFontFile",
            "color": "#EFEFEFFF"
        },
        "b": {
            "fontSize": 27,
            "fontUri": "font:SystemFontFile",
            "color": chainLookupReturn(m.global.session, "user.settings.colorCursor", ColorPalette.HIGHLIGHT)
        }
    }

    if isValid(m.version)
        m.version.drawingStyles = drawingStyles
        m.version.text = `${LCase(m.global.app.name)} ${m.global.app.version} - ${tr("What's New")}?`
    end if

    m.boolSetting = m.top.findNode("boolSetting")
    m.integerSetting = m.top.findNode("integerSetting")
    m.colorgrid = m.top.findNode("colorgrid")
    m.slider = m.top.findNode("slider")

    m.radioSetting = m.top.findNode("radioSetting")
    m.radioSetting.focusBitmapBlendColor = chainLookupReturn(m.global.session, "user.settings.colorCursor", ColorPalette.HIGHLIGHT)
    m.radioSetting.focusFootprintBlendColor = ColorPalette.TRANSPARENT
    m.radioSetting.focusedColor = ColorPalette.WHITE

    m.integerSetting.observeField("submit", "onKeyGridSubmit")
    m.integerSetting.observeField("escape", "onKeyGridEscape")

    m.settingsMenu.setFocus(true)
    m.settingsMenu.observeField("itemFocused", "settingFocused")
    m.settingsMenu.observeField("itemSelected", "settingSelected")

    m.boolSetting.observeField("checkedItem", "boolSettingChanged")
    m.radioSetting.observeField("checkedItem", "radioSettingChanged")
    m.colorgrid.observeField("itemSelected", "onColorSelected")
    m.slider.observeField("value", "onSliderSelected")

    m.postTask = createObject("roSGNode", "PostTask")

    m.keypressTimer = m.top.findNode("keypressTimer")
    m.keypressTimer.observeField("fire", "onKeypressTimerFire")

    ' String input dialog tracking
    m.currentStringSetting = invalid
    m.stringInputDialog = invalid

    ' Load Configuration Tree
    m.configTree = GetConfigTree()
    LoadMenu({ children: m.configTree })
end sub

sub onKeypressTimerFire()
    m.keypresses.clear()
end sub

sub onSliderSelected()
    if not isValid(m.slider.value) then return

    selectedSetting = m.userLocation.peek().children[m.settingsMenu.itemFocused]

    for each option in selectedSetting.options
        if not isValid(option.data) then continue for

        if isStringEqual(option.value, m.slider.value)
            set_user_setting(`${selectedSetting.settingName}Data`, option.data)
            exit for
        end if
    end for

    set_user_setting(selectedSetting.settingName, m.slider.value)
    m.settingsMenu.setFocus(true)
end sub

sub onColorSelected()
    selectedColor = m.colorgrid.content.getChild(m.colorgrid.itemSelected).colorCode
    m.colorgrid.selectedColor = selectedColor

    selectedSetting = m.userLocation.peek().children[m.settingsMenu.itemFocused]
    set_user_setting(selectedSetting.settingName, selectedColor ?? ColorPalette.VIEWBACKGROUND)

    ' Apply settings to items already loaded so user doesn't need to close the channel to see the changes

    ' Apply global background color
    if isStringEqual(selectedSetting.settingName, "colorBackground")
        scene = m.top.getScene()
        scene.backgroundColor = selectedColor ?? ColorPalette.VIEWBACKGROUND
    end if

    ' Apply cursor color
    if isStringEqual(selectedSetting.settingName, "colorCursor")
        ' Update cursor around user avatar
        scene = m.top.getScene()
        activeNav = getActiveNav(scene)
        if isValid(activeNav)
            overlayCurrentUserSelection = activeNav.findNode("overlayCurrentUserSelection")
            if isValid(overlayCurrentUserSelection)
                overlayCurrentUserSelection.blendColor = selectedColor ?? ColorPalette.HIGHLIGHT
            end if
        end if

        ' Update setting menu colors
        m.settingsMenu.focusBitmapBlendColor = selectedColor ?? ColorPalette.HIGHLIGHT
    end if

    ' Apply cursor color
    if isStringEqual(selectedSetting.settingName, "colorHomeUsername")
        ' Update cursor around user avatar
        scene = m.top.getScene()
        activeNav = getActiveNav(scene)
        if isValid(activeNav)
            overlayCurrentUser = activeNav.findNode("overlayCurrentUser")
            if isValid(overlayCurrentUser)
                overlayCurrentUser.color = selectedColor ?? ColorPalette.WHITE
            end if
        end if
    end if
end sub

sub onKeyGridSubmit()
    selectedSetting = m.userLocation.peek().children[m.settingsMenu.itemFocused]
    if isValid(selectedSetting.max) and m.integerSetting.text.ToInt() > selectedSetting.max.ToInt()
        m.integerSetting.text = selectedSetting.max
        return
    end if
    set_user_setting(selectedSetting.settingName, m.integerSetting.text)
    m.settingsMenu.setFocus(true)
end sub

sub onKeyGridEscape()
    if m.integerSetting.escape = "left" or m.integerSetting.escape = "back"
        m.settingsMenu.setFocus(true)
    end if
end sub

sub showStringInputDialog(settingItem as object)
    ' Show keyboard dialog for string input
    m.currentStringSetting = settingItem

    ' Get current value
    currentValue = get_user_setting(settingItem.settingName)
    if not isValid(currentValue) then currentValue = ""

    ' Determine if this is a password/secure field
    isSecure = (InStr(LCase(settingItem.settingName), "password") > 0 or InStr(LCase(settingItem.settingName), "apikey") > 0)

    ' Create keyboard dialog
    dialog = createObject("roSGNode", "StandardKeyboardDialog")
    dialog.title = tr(settingItem.title)
    dialog.text = currentValue

    if isSecure
        dialog.textEditBox.secureMode = true
    end if

    ' Set palette
    dlgPalette = createObject("roSGNode", "RSGPalette")
    dlgPalette.colors = {
        DialogBackgroundColor: chainLookupReturn(m.global.session, "user.settings.colorDialogBackground", ColorPalette.ELEMENTBACKGROUND),
        DialogFocusColor: chainLookupReturn(m.global.session, "user.settings.colorCursor", ColorPalette.HIGHLIGHT),
        DialogFocusItemColor: chainLookupReturn(m.global.session, "user.settings.colorDialogSelectedText", ColorPalette.WHITE),
        DialogTextColor: chainLookupReturn(m.global.session, "user.settings.colorDialogText", ColorPalette.WHITE)
    }
    dialog.palette = dlgPalette
    dialog.buttons = [tr("OK"), tr("Cancel")]

    m.stringInputDialog = dialog
    dialog.observeField("buttonSelected", "onStringInputDialogButton")
    m.top.getScene().dialog = dialog
end sub

sub onStringInputDialogButton(event as object)
    dialog = event.getRoSGNode()
    buttonIndex = dialog.buttonSelected

    if buttonIndex = 0 ' OK pressed
        ' Save the value
        newValue = dialog.text
        if isValid(m.currentStringSetting)
            set_user_setting(m.currentStringSetting.settingName, newValue)

            ' Special handling for Jellyseerr settings - update registry directly
            if InStr(m.currentStringSetting.settingName, "jellyseerr.") > 0
                sec = CreateObject("roRegistrySection", "jellyseerr")
                settingKey = Right(m.currentStringSetting.settingName, Len(m.currentStringSetting.settingName) - 11) ' Remove "jellyseerr." prefix
                sec.Write(settingKey, newValue)
                sec.Flush()

                ' Auto-authenticate if Jellyfin password was entered
                if m.currentStringSetting.settingName = "jellyseerr.jellyfinPassword" and newValue <> ""
                    ' Close dialog first
                    dialog.close = true
                    m.settingsMenu.setFocus(true)
                    m.currentStringSetting = invalid
                    settingFocused()

                    ' Trigger Jellyfin authentication
                    testJellyseerrConnection("jellyfin")
                    return
                end if
            end if
        end if
    end if

    ' Close dialog and return focus
    dialog.close = true
    m.settingsMenu.setFocus(true)
    m.currentStringSetting = invalid

    ' Refresh the focused item to show new value
    settingFocused()
end sub

sub testJellyseerrConnection(overrideAuthMethod = invalid as dynamic)
    ' Get the server URL
    serverUrl = m.global.session.user.settings["jellyseerr.url"]

    if serverUrl = invalid or serverUrl = ""
        ShowToast("Please enter Server URL first", "error")
        return
    end if

    ' Determine auth method: use override if provided, otherwise detect from which setting triggered this
    authMethod = invalid
    if isValid(overrideAuthMethod) and overrideAuthMethod <> ""
        authMethod = overrideAuthMethod
    end if

    if authMethod = "apikey" or authMethod = invalid
        apiKey = m.global.session.user.settings["jellyseerr.apiKey"]

        if apiKey = invalid or apiKey = ""
            if authMethod = "apikey"
                ShowToast("Please enter API Key first", "error")
                return
            end if
            ' If no specific method and no API key, skip this method
        else
            ' Use API Key auth
            authMethod = "apikey"

            ' Save credentials to registry first so the API task can use them
            sec = CreateObject("roRegistrySection", "jellyseerr")
            sec.Write("serverUrl", serverUrl)
            sec.Write("apiKey", apiKey)
            sec.Write("authMethod", "apikey")
            sec.Flush()

            ' Create API task to test connection
            testTask = CreateObject("roSGNode", "JellyseerrAPITask")
            testTask.request = {
                method: "GET",
                endpoint: "/api/v1/user"
            }
            testTask.observeField("response", "onApiKeyTestResponse")
            testTask.control = "RUN"
            m.testConnectionTask = testTask
            return
        end if
    end if

    if authMethod = "jellyfin" or authMethod = invalid
        ' Use the currently logged-in Jellyfin user's name
        username = m.global.session.user.name
        password = m.global.session.user.settings["jellyseerr.jellyfinPassword"]

        if not isValidString(username)
            if authMethod = "jellyfin"
                ShowToast("Unable to get Jellyfin username", "error")
                return
            end if
            ' If no specific method and no username, skip this method
        else if password = invalid or not isValidString(password)
            if authMethod = "jellyfin"
                ShowToast("Please enter your Jellyfin password", "error")
                return
            end if
            ' If no specific method and no password, skip this method
        else
            ' Use Jellyfin auth
            authMethod = "jellyfin"

            ' Create authentication task
            authTask = CreateObject("roSGNode", "JellyseerrAuthTask")
            authTask.serverUrl = serverUrl
            authTask.authEndpoint = "/api/v1/auth/jellyfin"
            authTask.authBody = JellyseerrFormatJson({
                username: username,
                password: password
            })
            authTask.observeField("response", "onJellyfinAuthResponse")
            authTask.control = "RUN"
            m.authTask = authTask
            return
        end if
    end if

    if authMethod = "local" or authMethod = invalid
        email = m.global.session.user.settings["jellyseerr.localEmail"]
        password = m.global.session.user.settings["jellyseerr.localPassword"]

        if email = invalid or email = "" or password = invalid or password = ""
            if authMethod = "local"
                ShowToast("Please enter Jellyseerr email and password", "error")
                return
            end if
            ' If no specific method provided, we've exhausted all options
            ShowToast("Please configure one of the authentication methods", "error")
            return
        end if

        ' Create authentication task
        authTask = CreateObject("roSGNode", "JellyseerrAuthTask")
        authTask.serverUrl = serverUrl
        authTask.authEndpoint = "/api/v1/auth/local"
        authTask.authBody = JellyseerrFormatJson({
            email: email,
            password: password
        })
        authTask.observeField("response", "onLocalAuthResponse")
        authTask.control = "RUN"
        m.authTask = authTask
    end if
end sub

sub onApiKeyTestResponse(event as object)
    response = event.getData()

    ' Build detailed message for modal
    dialogMessage = ""
    if response.success
        dialogMessage = "Connection successful! API key is valid."
        if response.rawResponse <> invalid and response.rawResponse <> ""
            dialogMessage = dialogMessage + Chr(10) + Chr(10) + "Server Response:" + Chr(10) + response.rawResponse
        end if
    else
        dialogMessage = "Connection failed"
        if response.error <> invalid and response.error <> ""
            dialogMessage = dialogMessage + Chr(10) + Chr(10) + "Error: " + response.error
        end if
        if response.statusCode <> invalid
            dialogMessage = dialogMessage + Chr(10) + "Status Code: " + response.statusCode.ToStr()
        end if
    end if

    ' Show modal dialog using StandardMessageDialog
    dialog = createObject("roSGNode", "StandardMessageDialog")
    dialog.title = "API Key Test"
    dialog.message = dialogMessage
    dialog.buttons = ["OK"]
    dialog.observeField("buttonSelected", "onAuthModalClosed")
    m.top.getScene().dialog = dialog

    ' Refresh the settings display to show updated auth status
    if response.success then settingFocused()
end sub

sub onJellyfinAuthResponse(event as object)
    response = event.getData()

    dialogMessage = ""
    dialogTitle = "Jellyseerr Authentication"

    if response <> invalid and response.success
        ' For Jellyfin auth, we need to save the session cookie, not an API key
        if response.cookies <> invalid and response.cookies <> ""
            ' Get current user ID and save to per-user registry
            userId = GetCurrentJellyfinUserId()
            if userId = ""
                dialogTitle = "✗ Error"
                dialogMessage = "Unable to get current user ID"
            else
                serverUrl = m.global.session.user.settings["jellyseerr.url"]

                ' Save to global registry (serverUrl)
                SetJellyseerrGlobalConfig(serverUrl, true)

                ' Save to per-user registry (cookie and auth method)
                SetJellyseerrUserConfig(userId, response.cookies, "jellyfin", "", "", "")

                ' Fetch user permissions after successful auth
                FetchJellyseerrUserPermissions(userId)

                dialogTitle = "✓ Authentication Successful"
                dialogMessage = "Successfully connected to Jellyseerr!" + Chr(10) + Chr(10)
                dialogMessage = dialogMessage + "Your credentials have been saved and will persist across sessions."

                ' Mark session as validated for this app session
                if m.global <> invalid
                    m.global.addFields({ jellyseerrSessionValidated: true })
                end if

                ' Refresh the settings display to show updated auth status
                settingFocused()
            end if
        else
            dialogTitle = "✓ Connected (No Cookie)"
            dialogMessage = "Authentication succeeded but no session cookie was returned." + Chr(10) + Chr(10)
            dialogMessage = dialogMessage + "Status Code: " + response.statusCode.ToStr() + Chr(10) + Chr(10)
            dialogMessage = dialogMessage + "Please check your Jellyseerr server configuration."
        end if
    else
        dialogTitle = "✗ Authentication Failed"
        dialogMessage = "Jellyfin authentication failed" + Chr(10) + Chr(10)

        if response <> invalid
            dialogMessage = dialogMessage + "Status Code: " + response.statusCode.ToStr() + Chr(10)

            if response.error <> invalid and response.error <> ""
                dialogMessage = dialogMessage + "Error: " + response.error + Chr(10)
            end if

            if response.rawResponse <> invalid and response.rawResponse <> ""
                ' Show first 200 chars of error response
                errorPreview = response.rawResponse
                if Len(errorPreview) > 200
                    errorPreview = Left(errorPreview, 200) + "..."
                end if
                dialogMessage = dialogMessage + Chr(10) + "Response: " + errorPreview
            end if
        else
            dialogMessage = dialogMessage + "No response received from server."
        end if
    end if

    ' Show modal dialog
    if dialogTitle <> invalid and dialogTitle <> "" and dialogMessage <> invalid and dialogMessage <> ""
        dialog = CreateObject("roSGNode", "StandardMessageDialog")
        if dialog <> invalid
            dialog.title = dialogTitle
            dialog.message = [dialogMessage]
            dialog.buttons = ["OK"]
            dialog.observeField("buttonSelected", "onAuthModalClosed")
            m.top.getScene().dialog = dialog
        end if
    end if
end sub

sub onLocalAuthResponse(event as object)
    response = event.getData()

    dialogMessage = ""
    dialogTitle = "Jellyseerr Authentication"

    if response <> invalid and response.success
        ' Local auth can also use cookies like Jellyfin auth
        if response.cookies <> invalid and response.cookies <> ""
            ' Get current user ID and save to per-user registry
            userId = GetCurrentJellyfinUserId()
            if userId = ""
                dialogTitle = "✗ Error"
                dialogMessage = "Unable to get current user ID"
            else
                serverUrl = m.global.session.user.settings["jellyseerr.url"]

                ' Save to global registry (serverUrl)
                SetJellyseerrGlobalConfig(serverUrl, true)

                ' Save to per-user registry (cookie and auth method)
                SetJellyseerrUserConfig(userId, response.cookies, "local", "", "", "")

                ' Fetch user permissions after successful auth
                FetchJellyseerrUserPermissions(userId)

                dialogTitle = "✓ Authentication Successful"
                dialogMessage = "Successfully connected to Jellyseerr!" + Chr(10) + Chr(10)
                dialogMessage = dialogMessage + "Your credentials have been saved and will persist across sessions."

                ' Mark session as validated for this app session
                if m.global <> invalid
                    m.global.addFields({ jellyseerrSessionValidated: true })
                end if

                ' Refresh the settings display to show updated auth status
                settingFocused()
            end if
        else
            dialogTitle = "✓ Connected (No Cookie)"
            dialogMessage = "Authentication succeeded but no session cookie was returned." + Chr(10) + Chr(10)
            dialogMessage = dialogMessage + "Status Code: " + response.statusCode.ToStr() + Chr(10) + Chr(10)
            dialogMessage = dialogMessage + "Please check your Jellyseerr server configuration."
        end if
    else
        dialogTitle = "✗ Authentication Failed"
        dialogMessage = "Jellyseerr authentication failed" + Chr(10) + Chr(10)

        if response <> invalid
            dialogMessage = dialogMessage + "Status Code: " + response.statusCode.ToStr() + Chr(10)

            if response.error <> invalid and response.error <> ""
                dialogMessage = dialogMessage + "Error: " + response.error + Chr(10)
            end if

            if response.rawResponse <> invalid and response.rawResponse <> ""
                ' Show first 200 chars of error response
                errorPreview = response.rawResponse
                if Len(errorPreview) > 200
                    errorPreview = Left(errorPreview, 200) + "..."
                end if
                dialogMessage = dialogMessage + Chr(10) + "Response: " + errorPreview
            end if
        else
            dialogMessage = dialogMessage + "No response received from server."
        end if
    end if

    ' Show modal dialog
    if dialogTitle <> invalid and dialogTitle <> "" and dialogMessage <> invalid and dialogMessage <> ""
        dialog = CreateObject("roSGNode", "StandardMessageDialog")
        if dialog <> invalid
            dialog.title = dialogTitle
            dialog.message = [dialogMessage]
            dialog.buttons = ["OK"]
            dialog.observeField("buttonSelected", "onAuthModalClosed")
            m.top.getScene().dialog = dialog
        end if
    end if
end sub

function GetJellyseerrAuthStatus() as string
    ' Check current authentication status for Jellyseerr
    serverUrl = m.global.session.user.settings["jellyseerr.url"]

    if not isValidString(serverUrl)
        return "Status: Not configured - Please enter Server URL"
    end if

    ' Check registry for saved authentication (indicates successful auth)
    sec = CreateObject("roRegistrySection", "jellyseerr")
    savedApiKey = sec.Read("apiKey")
    savedAuthCookie = sec.Read("authCookie")
    savedServerUrl = sec.Read("serverUrl")
    savedAuthMethod = sec.Read("authMethod")

    if savedServerUrl = serverUrl and (isValidString(savedApiKey) or isValidString(savedAuthCookie))
        methodDisplay = "API Key"
        if savedAuthMethod = "jellyfin"
            methodDisplay = "Jellyfin SSO"
        else if savedAuthMethod = "local"
            methodDisplay = "Jellyseerr Login"
        end if
        return "Status: Authenticated (" + methodDisplay + ")"
    end if

    return "Status: Not authenticated - Configure one of the login methods below"
end function

' Helper function to check if a value is a valid non-empty string
function isValidString(value as dynamic) as boolean
    if value = invalid then return false
    if type(value) <> "String" and type(value) <> "roString" then return false
    return value <> ""
end function

sub ShowToast(message as string, _toastType = "" as string)
    ' Create a simple toast notification using JFMessageDialog
    toast = createObject("roSGNode", "JFMessageDialog")
    toast.message = message
    toast.options = ["OK"]
    m.top.getScene().appendChild(toast)
    toast.observeField("backPressed", "onToastClosed")
    toast.setFocus(true)
end sub

' Handle toast dialog closed
sub onToastClosed(obj as object)
    dialog = obj.getRoSGNode()
    m.top.getScene().removeChild(dialog)
    m.settingsMenu.setFocus(true)
end sub

sub openJellyseerrAuthScreen()
    ' Open the Jellyseerr authentication screen
    authScreen = CreateObject("roSGNode", "JellyseerrAuthScreen")
    m.top.getScene().appendChild(authScreen)
    authScreen.setFocus(true)
end sub

sub RefreshCurrentMenu()
    ' Reload the current menu level to apply visibility changes
    currentSection = m.userLocation.peek()
    m.userLocation.pop()
    LoadMenu(currentSection, false)
    m.userLocation.push(currentSection)
end sub

sub LoadMenu(configSection, appendPath = true as boolean)
    if configSection.children = invalid
        ' Load parent menu
        m.userLocation.pop()
        configSection = m.userLocation.peek()
    else
        settingsArray = []

        for each item in configSection.children
            settingsArray.push(item)
        end for

        configSection.children = settingsArray

        if appendPath
            if m.userLocation.Count() > 0 then m.userLocation.peek().selectedIndex = m.settingsMenu.itemFocused
            m.userLocation.push(configSection)
        end if
    end if

    result = CreateObject("roSGNode", "ContentNode")
    m.settingsMenu.content = result

    ' Create a mapping array to track which config items are visible
    m.visibleItemsMap = []

    for each item in configSection.children
        if isValid(item.visible)
            if not item.visible
                if not m.showSecretMenu
                    continue for
                end if
            end if
        end if

        ' Add to visible items mapping
        m.visibleItemsMap.push(item)

        listItem = result.CreateChild("ContentNode")
        listItem.title = tr(item.title)
        listItem.Description = tr(item.description)
        listItem.id = item.id
    end for

    if configSection.selectedIndex <> invalid and configSection.selectedIndex > -1
        m.settingsMenu.jumpToItem = configSection.selectedIndex
    end if

    ' Set Path display
    if appendPath
        m.path.text = tr("Settings")
        for each level in m.userLocation
            if level.title <> invalid then m.path.text += " / " + tr(level.title)
        end for
    end if
end sub

sub settingFocused()

    ' Use visibleItemsMap to get the correct item
    if not isValid(m.visibleItemsMap) or m.settingsMenu.itemFocused >= m.visibleItemsMap.count()
        selectedSetting = m.userLocation.peek().children[m.settingsMenu.itemFocused]
    else
        selectedSetting = m.visibleItemsMap[m.settingsMenu.itemFocused]
    end if

    ' Validate selectedSetting exists before using it
    if not isValid(selectedSetting) then return

    m.settingDesc.text = tr(selectedSetting.Description)

    ' Hide Settings
    m.boolSetting.visible = false
    m.integerSetting.visible = false
    m.radioSetting.visible = false
    m.colorgrid.visible = false
    m.slider.visible = false

    if not isValid(selectedSetting.type) then return

    if isStringEqual(selectedSetting.type, "colorgrid")
        m.colorgrid.setting = selectedSetting
        m.colorgrid.visible = true
        return
    end if

    if isStringEqual(selectedSetting.type, SettingType.SLIDER)
        m.slider.value = m.global.session.user.settings[selectedSetting.settingName]

        sliderOptions = []
        for each item in m.userLocation.peek().children[m.settingsMenu.itemFocused].options
            sliderOptions.push(item.value)
        end for

        m.slider.options = sliderOptions
        m.slider.visible = true
        return
    end if

    if isStringEqual(selectedSetting.type, "bool")
        m.boolSetting.visible = true

        if m.global.session.user.settings[selectedSetting.settingName] = true
            m.boolSetting.checkedItem = 1
        else
            m.boolSetting.checkedItem = 0
        end if

        ' Special handling for Jellyseerr test connection - show auth status
        if isStringEqual(selectedSetting.settingName, "jellyseerr.testConnection")
            authStatus = GetJellyseerrAuthStatus()
            m.settingDesc.text = tr(selectedSetting.Description) + Chr(10) + Chr(10) + authStatus
        end if

        return
    end if

    if isStringEqual(selectedSetting.type, "integer")
        integerValue = m.global.session.user.settings[selectedSetting.settingName].ToStr()
        if isValid(integerValue)
            m.integerSetting.text = integerValue
        end if
        m.integerSetting.visible = true

        return
    end if

    if isStringEqual(selectedSetting.type, "radio")
        ' Translate user's old setting value to the new value so it doesn't get reset
        if isStringEqual(selectedSetting.settingName, "playback.media.forceTranscode")
            originalSelectedValue = m.global.session.user.settings[selectedSetting.settingName]

            if isStringEqual(type(originalSelectedValue), "roBoolean") or isStringEqual(type(originalSelectedValue), "Boolean")
                convertedValue = originalSelectedValue ? PlaybackMethod.FORCETRANSCODEALLOWREMUX : m.userLocation.peek().children[m.settingsMenu.itemFocused].default
                set_user_setting(selectedSetting.settingName, convertedValue)
            end if
        end if

        selectedValue = m.global.session.user.settings[selectedSetting.settingName]

        radioContent = CreateObject("roSGNode", "ContentNode")

        itemIndex = 0
        for each item in m.userLocation.peek().children[m.settingsMenu.itemFocused].options
            listItem = radioContent.CreateChild("ContentNode")
            listItem.title = tr(item.title)
            listItem.id = item.id
            if selectedValue = item.id
                m.radioSetting.checkedItem = itemIndex
            end if
            itemIndex++
        end for

        m.radioSetting.content = radioContent

        m.radioSetting.visible = true

        return
    end if

    if isStringEqual(selectedSetting.type, "string")
        ' String type - show current value in description
        currentValue = get_user_setting(selectedSetting.settingName)
        ' Only display if it's actually a valid string (not a boolean or other type)
        if isValidString(currentValue)
            ' Mask sensitive fields like API keys and passwords - don't show any value
            if InStr(LCase(selectedSetting.settingName), "apikey") > 0 or InStr(LCase(selectedSetting.settingName), "password") > 0
                m.settingDesc.text = tr(selectedSetting.Description) + Chr(10) + Chr(10) + "Current: ••••••••"
            else
                m.settingDesc.text = tr(selectedSetting.Description) + Chr(10) + Chr(10) + "Current: " + currentValue
            end if
        end if
        return
    end if
end sub

sub settingSelected()
    ' Use visibleItemsMap to get the correct item
    if not isValid(m.visibleItemsMap) or m.settingsMenu.itemFocused >= m.visibleItemsMap.count()
        selectedItem = m.userLocation.peek().children[m.settingsMenu.itemFocused]
    else
        selectedItem = m.visibleItemsMap[m.settingsMenu.itemFocused]
    end if

    if not isValid(selectedItem) then return

    ' Special handling for donation dialog
    if isValid(selectedItem.settingName) and selectedItem.settingName = "moonfin.showDonation"
        showDonationDialog()
        return
    end if

    ' Special handling for Jellyseerr local account connect button
    if isValid(selectedItem.settingName) and selectedItem.settingName = "jellyseerr.testConnectionLocal"
        testJellyseerrConnection("local")
        return
    end if

    ' Legacy test connection button (deprecated, keeping for backwards compatibility)
    if isValid(selectedItem.settingName) and selectedItem.settingName = "jellyseerr.testConnection"
        testJellyseerrConnection()
        return
    end if

    if selectedItem.type <> invalid ' Show setting
        if isStringEqual(selectedItem.type, SettingType.BOOL)
            m.boolSetting.setFocus(true)
        end if
        if isStringEqual(selectedItem.type, SettingType.COLORGRID)
            m.colorgrid.setFocus(true)
        end if
        if isStringEqual(selectedItem.type, SettingType.integer)
            m.integerSetting.setFocus(true)
        end if
        if isStringEqual(selectedItem.type, SettingType.RADIO)
            m.radioSetting.setFocus(true)
        end if
        if isStringEqual(selectedItem.type, SettingType.SLIDER)
            m.slider.setFocus(true)
        end if
        if isStringEqual(selectedItem.type, SettingType.STRING)
            ' Open keyboard dialog for string input
            showStringInputDialog(selectedItem)
        end if
    else if selectedItem.children <> invalid and selectedItem.children.Count() > 0 ' Show sub menu
        LoadMenu(selectedItem)
        m.settingsMenu.setFocus(true)
    else
        return
    end if

    ' Use selectedItem directly instead of re-fetching from content
    if isValid(selectedItem.Description)
        m.settingDesc.text = selectedItem.Description
    end if

end sub

sub refreshMenu()
    selectedItem = m.userLocation[m.userLocation.count() - 1]
    LoadMenu(selectedItem, false)
end sub

sub boolSettingChanged()
    if m.boolSetting.focusedChild = invalid then return
    selectedSetting = m.userLocation.peek().children[m.settingsMenu.itemFocused]

    ' checkedItem is 0 for "Disabled" (index 0) and 1 for "Enabled" (index 1)
    if m.boolSetting.checkedItem = 1
        session.user.settings.Save(selectedSetting.settingName, "true")
        if Left(selectedSetting.settingName, 7) = "global."
            ' global user setting
            ' save to main registry block
            set_setting(selectedSetting.settingName, "true")
            ' setting specific triggers
            if selectedSetting.settingName = "global.rememberme"
                set_setting("active_user", m.global.session.user.id)
            end if
        else
            ' regular user setting
            ' save to user specific registry block
            set_user_setting(selectedSetting.settingName, "true")
        end if
    else
        session.user.settings.Save(selectedSetting.settingName, "false")
        if Left(selectedSetting.settingName, 7) = "global."
            ' global user setting
            ' save to main registry block
            set_setting(selectedSetting.settingName, "false")
            ' setting specific triggers
            if selectedSetting.settingName = "global.rememberme"
                unset_setting("active_user")
            end if
        else
            ' regular user setting
            ' save to user specific registry block
            set_user_setting(selectedSetting.settingName, "false")
        end if
    end if
end sub

sub radioSettingChanged()
    if m.radioSetting.focusedChild = invalid then return
    selectedSetting = m.userLocation.peek().children[m.settingsMenu.itemFocused]
    set_user_setting(selectedSetting.settingName, m.radioSetting.content.getChild(m.radioSetting.checkedItem).id)

    ' Notify components when overlay settings change
    if isStringEqual(selectedSetting.settingName, "ui.overlayOpacity") or isStringEqual(selectedSetting.settingName, "ui.overlayColor")
        if isValid(m.global)
            m.global.overlaySettingsChanged = m.global.overlaySettingsChanged + 1
        end if
    end if

    if isStringEqual(selectedSetting.settingName, "imageBackground")
        scene = m.top.getScene()

        selectedBackgroundImage = m.radioSetting.content.getChild(m.radioSetting.checkedItem).id

        if isStringEqual(selectedBackgroundImage, "splash")
            selectedBackgroundImage = api.branding.GetSplashScreen({
                format: "jpg",
                foregroundLayer: 1,
                fillWidth: 1920,
                width: 1920,
                fillHeight: 1080,
                height: 1080,
                tag: "splash"
            })
        end if

        scene.callFunc("setBackgroundImage", selectedBackgroundImage)
    end if

    if isStringEqual(selectedSetting.settingName, "navbar.position")
        selectedPosition = m.radioSetting.content.getChild(m.radioSetting.checkedItem).id
        scene = m.top.getScene()
        if isValid(scene)
            overhang = scene.findNode("overhang")
            sidebar = scene.findNode("sidebar")
            if isStringEqual(selectedPosition, "left")
                if isValid(overhang)
                    overhang.visible = false
                    overhang.isVisible = false
                end if
                if isValid(sidebar)
                    sidebar.visible = true
                    sidebar.callFunc("loadLibraries")
                end if
            else
                if isValid(sidebar)
                    sidebar.visible = false
                end if
                if isValid(overhang)
                    overhang.visible = true
                    overhang.isVisible = true
                    overhang.callFunc("loadLibraries")
                end if
            end if
            m.global.sceneManager.callFunc("refreshNavReference")
        end if
    end if

    if isStringEqual(selectedSetting.settingName, "playback.media.forceTranscode")
        if isStringEqual(m.radioSetting.content.getChild(m.radioSetting.checkedItem).id, PlaybackMethod.PLAYNORMALLY)
            m.global.queueManager.callFunc("setForceTranscode", PlaybackMethod.PLAYNORMALLY)
        end if
    end if
end sub

' JFScreen hook called when screen is shown
sub OnScreenShown(_isReturning = false as boolean)
    ' Restore focus to settings menu when returning to this screen
    if isValid(m.settingsMenu)
        m.settingsMenu.setFocus(true)
    end if
end sub

' JFScreen hook that gets ran as needed.
' Assumes settings were changed and they affect the device profile.
' Posts a new device profile to the server using the task thread
sub OnScreenHidden()
    m.postTask.arrayData = getDeviceCapabilities()
    m.postTask.apiUrl = "/Sessions/Capabilities/Full"
    m.postTask.control = "RUN"
    m.postTask.observeField("responseCode", "postFinished")
end sub

' Triggered by m.postTask after completing a post.
' Empty the task data when finished.
sub postFinished()
    m.postTask.unobserveField("responseCode")
    m.postTask.callFunc("empty")
end sub

' Returns true if any of the data entry forms are in focus
function isFormInFocus() as boolean
    if m.radioSetting.hasFocus() or m.boolSetting.hasFocus() or m.integerSetting.hasFocus() or m.colorgrid.hasFocus() or m.slider.hasFocus()
        return true
    end if
    return false
end function

sub checkMagicKeyPressSequence(key as string)
    m.keypressTimer.control = "stop"
    m.keypressTimer.control = "start"

    m.keypresses.push(key)

    if m.keypresses.count() < m.magicKeyPressSequence.count() then return

    for i = 0 to m.keypresses.count()
        if m.keypresses[i] <> m.magicKeyPressSequence[i] then return
    end for

    m.showSecretMenu = true
    LoadMenu({ children: m.configTree })
end sub

function onKeyEvent(key as string, press as boolean) as boolean
    if not press then return false

    checkMagicKeyPressSequence(key)

    ' Navigate to overhang with UP key from settings menu
    if key = KeyCode.UP and isValid(m.settingsMenu) and m.settingsMenu.hasFocus()
        if m.settingsMenu.itemFocused = 0
            m.top.lastFocus = m.settingsMenu
            return FocusOverhang(m.top)
        end if
    end if

    if (key = "back" or key = "left") and m.settingsMenu.focusedChild <> invalid and m.userLocation.Count() > 1
        LoadMenu({})
        return true
    else if (key = "back" or key = "left") and isFormInFocus()
        m.settingsMenu.setFocus(true)
        return true
    end if

    if key = "options"
        m.global.sceneManager.callFunc("popScene")
        return true
    end if

    if isValid(m.version)
        if isStringEqual(key, KeyCode.DOWN)
            if m.settingsMenu.hasFocus()
                m.version.setfocus(true)
                m.version.text = `${LCase(m.global.app.name)} ${m.global.app.version} - <b>${tr("What's New")}?</b>`
                return true
            end if
        end if

        if m.version.hasFocus()
            if isStringEqual(key, KeyCode.UP)
                m.settingsMenu.setfocus(true)
                m.version.text = `${LCase(m.global.app.name)} ${m.global.app.version} - ${tr("What's New")}?`
                return true
            end if

            if isStringEqual(key, KeyCode.OK)
                m.global.sceneManager.callFunc("whatsNewDialog")
                return true
            end if
            return false
        end if
    end if

    if key = "right"
        settingSelected()
    end if

    return false
end function

' Handle authentication modal closed
sub onAuthModalClosed(_obj as object)
    ' Close the dialog
    m.top.getScene().dialog.close = true
    m.settingsMenu.setFocus(true)
end sub

' Show donation dialog
sub showDonationDialog()
    ' Create the donation dialog
    dialog = createObject("roSGNode", "DonationDialog")
    dialog.observeField("wasClosed", "onDonationDialogClosed")

    ' Add dialog to the scene
    m.top.getScene().appendChild(dialog)
    m.donationDialog = dialog
end sub

' Handle donation dialog closed
sub onDonationDialogClosed(_obj as object)
    ' Remove the dialog from the scene
    if isValid(m.donationDialog)
        m.top.getScene().removeChild(m.donationDialog)
        m.donationDialog = invalid
    end if

    ' Return focus to settings menu
    m.settingsMenu.setFocus(true)
end sub

' ============================================
' Jellyseerr Permissions
' ============================================

' Fetch user permissions from Jellyseerr /auth/me endpoint
sub FetchJellyseerrUserPermissions(userId as string)
    m.permissionsTask = CreateObject("roSGNode", "JellyseerrAPITask")
    m.permissionsTask.addFields({ targetUserId: userId })
    m.permissionsTask.request = {
        method: "GET",
        endpoint: "/api/v1/auth/me"
    }
    m.permissionsTask.observeField("response", "onPermissionsResponse")
    m.permissionsTask.control = "RUN"
end sub

sub onPermissionsResponse(event as object)
    response = event.getData()
    task = event.getRoSGNode()
    userId = task.targetUserId


    if response.success and response.data <> invalid
        permissions = 0
        if response.data.permissions <> invalid
            permissions = response.data.permissions
        end if
        SetJellyseerrUserPermissions(userId, permissions)
    else
    end if
end sub
