import "pkg:/source/api/baserequest.bs"
import "pkg:/source/api/sdk.bs"
import "pkg:/source/enums/PlaybackMethod.bs"
import "pkg:/source/utils/config.bs"
import "pkg:/source/utils/deviceCapabilities.bs"
import "pkg:/source/utils/misc.bs"

sub init()
    m.top.functionName = "getPlaybackInfoTask"
end sub

function ItemPostPlaybackInfo(id as string)
    currentView = m.global.sceneManager.callFunc("getActiveScene")
    currentItem = m.global.queueManager.callFunc("getCurrentItem")

    body = {
        "DeviceProfile": getDeviceProfile()
    }

    ' Check if we have multi-server info
    serverUrl = m.top.serverUrl
    serverUserId = m.top.serverUserId
    serverAuthToken = m.top.serverAuthToken

    useMultiServer = isValidAndNotEmpty(serverUrl) and isValidAndNotEmpty(serverUserId) and isValidAndNotEmpty(serverAuthToken)

    if useMultiServer
        ' Use the specified server instead of global session
        params = {
            "UserId": serverUserId,
            "StartTimeTicks": currentItem.startingPoint,
            "IsPlayback": true,
            "AutoOpenLiveStream": true,
            "MaxStreamingBitrate": "140000000",
            "MaxStaticBitrate": "140000000",
            "SubtitleStreamIndex": currentView.selectedSubtitle,
            "MediaSourceId": currentItem.id,
            "AudioStreamIndex": currentItem.selectedAudioStreamIndex
        }

        req = APIRequestForServer(serverUrl, serverUserId, serverAuthToken, Substitute("Items/{0}/PlaybackInfo", id), params)
        if not isValid(req) then return invalid

        req.SetRequest("POST")
        return postJson(req, FormatJson(body))
    else
        ' Use the global session (original behavior)
        params = {
            "UserId": m.global.session.user.id,
            "StartTimeTicks": currentItem.startingPoint,
            "IsPlayback": true,
            "AutoOpenLiveStream": true,
            "MaxStreamingBitrate": "140000000",
            "MaxStaticBitrate": "140000000",
            "SubtitleStreamIndex": currentView.selectedSubtitle,
            "MediaSourceId": currentItem.id,
            "AudioStreamIndex": currentItem.selectedAudioStreamIndex
        }

        req = APIRequest(Substitute("Items/{0}/PlaybackInfo", id), params)
        req.SetRequest("POST")
        return postJson(req, FormatJson(body))
    end if
end function

' Returns an array of playback info to be displayed during playback.
' In the future, with a custom playback info view, we can return an associated array.
sub getPlaybackInfoTask()
    sessions = api.sessions.Get({ "deviceId": m.global.device.serverDeviceName })

    m.playbackInfo = ItemPostPlaybackInfo(m.top.videoID)

    if isValid(sessions) and sessions.Count() > 0
        m.top.data = { playbackInfo: GetTranscodingStats(sessions[0]) }
    else
        m.top.data = { playbackInfo: { data: ["<b>" + tr("Unable to get playback information" + "</b>")] } }
    end if
end sub

function GetTranscodingStats(deviceSession)
    sessionStats = { data: [] }

    ' Section 1: Playback Method
    sessionStats.data.push("<header>" + tr("Playback Method") + "</header>")

    if isValid(deviceSession.TranscodingInfo) and deviceSession.TranscodingInfo.Count() > 0
        ' Transcoding is active
        sessionStats.data.push("<b>" + tr("Method") + ":</b> " + tr("Transcoding"))

        ' Show transcoding reasons
        transcodingReasons = deviceSession.TranscodingInfo.TranscodeReasons
        if not isStringEqual(PlaybackMethod.PLAYNORMALLY, m.global.session.user.settings["playback.media.forceTranscode"])
            sessionStats.data.push("<b>" + tr("Reason") + ":</b> " + tr("Force Transcoding setting is enabled"))
        else if not isStringEqual(PlaybackMethod.PLAYNORMALLY, m.global.queueManager.callFunc("getForceTranscode"))
            sessionStats.data.push("<b>" + tr("Reason") + ":</b> " + tr("Force Transcode option is enabled"))
        else if isValid(transcodingReasons) and transcodingReasons.Count() > 0
            for i = 0 to transcodingReasons.Count() - 1
                if i = 0
                    sessionStats.data.push("<b>" + tr("Reason") + ":</b> " + transcodingReasons[i])
                else
                    sessionStats.data.push("           " + transcodingReasons[i])
                end if
            end for
        end if
    else
        ' Direct Play
        sessionStats.data.push("<b>" + tr("Method") + ":</b> " + tr("Direct Play"))
    end if

    ' Section 2: Stream Information
    if havePlaybackInfo()
        mediaSource = m.playbackInfo.mediaSources[0]
        sessionStats.data.push("")
        sessionStats.data.push("<header>" + tr("Stream Information") + "</header>")

        if isValid(mediaSource.Container)
            sessionStats.data.push("<b>" + tr("Container") + ":</b> " + UCase(mediaSource.Container))
        end if

        if isValid(mediaSource.Bitrate)
            sessionStats.data.push("<b>" + tr("Bitrate") + ":</b> " + getDisplayBitrate(mediaSource.Bitrate))
        end if

        if isValid(mediaSource.Size)
            sizeGB = (mediaSource.Size / 1073741824.0)
            sessionStats.data.push("<b>" + tr("File Size") + ":</b> " + formatFloat(sizeGB, 2) + " GB")
        end if

        ' Section 3: Video Details
        videoStream = invalid
        audioStream = invalid

        ' Find video and audio streams
        for each stream in mediaSource.MediaStreams
            if stream.Type = "Video" and videoStream = invalid
                videoStream = stream
            else if stream.Type = "Audio" and audioStream = invalid
                audioStream = stream
            end if
        end for

        ' Video information
        if isValid(videoStream)
            sessionStats.data.push("")
            sessionStats.data.push("<header>" + tr("Video") + "</header>")

            if isValid(videoStream.DisplayTitle)
                sessionStats.data.push("<b>" + tr("Stream") + ":</b> " + videoStream.DisplayTitle)
            end if

            if isValid(videoStream.Codec)
                videoCodecDisplay = UCase(videoStream.Codec)

                ' Show if video is direct or transcoded
                if isValid(deviceSession.TranscodingInfo) and deviceSession.TranscodingInfo.Count() > 0
                    if deviceSession.TranscodingInfo.IsVideoDirect
                        videoCodecDisplay = videoCodecDisplay + " (" + tr("Direct") + ")"
                    else if isValid(deviceSession.TranscodingInfo.VideoCodec)
                        videoCodecDisplay = UCase(deviceSession.TranscodingInfo.VideoCodec) + " (" + tr("Transcoded from") + " " + UCase(videoStream.Codec) + ")"
                    end if
                end if

                sessionStats.data.push("<b>" + tr("Codec") + ":</b> " + videoCodecDisplay)
            end if

            if isValid(videoStream.Width) and isValid(videoStream.Height)
                resolution = Str(videoStream.Width) + "x" + Str(videoStream.Height)
                resolutionName = ""
                if videoStream.Height >= 2160
                    resolutionName = " (4K)"
                else if videoStream.Height >= 1080
                    resolutionName = " (1080p)"
                else if videoStream.Height >= 720
                    resolutionName = " (720p)"
                else if videoStream.Height >= 480
                    resolutionName = " (480p)"
                end if
                sessionStats.data.push("<b>" + tr("Resolution") + ":</b> " + resolution + resolutionName)
            end if

            if isValid(videoStream.BitRate)
                sessionStats.data.push("<b>" + tr("Bitrate") + ":</b> " + getDisplayBitrate(videoStream.BitRate))
            end if

            if isValid(videoStream.VideoRangeType) and videoStream.VideoRangeType <> "SDR"
                sessionStats.data.push("<b>" + tr("Range") + ":</b> " + UCase(videoStream.VideoRangeType))
            end if

            if isValid(videoStream.AverageFrameRate)
                fps = videoStream.AverageFrameRate
                sessionStats.data.push("<b>" + tr("Frame Rate") + ":</b> " + formatFloat(fps, 2) + " fps")
            else if isValid(videoStream.RealFrameRate)
                fps = videoStream.RealFrameRate
                sessionStats.data.push("<b>" + tr("Frame Rate") + ":</b> " + formatFloat(fps, 2) + " fps")
            end if
        end if

        ' Audio information
        if isValid(audioStream)
            sessionStats.data.push("")
            sessionStats.data.push("<header>" + tr("Audio") + "</header>")

            if isValid(audioStream.DisplayTitle)
                sessionStats.data.push("<b>" + tr("Stream") + ":</b> " + audioStream.DisplayTitle)
            end if

            if isValid(audioStream.Codec)
                audioCodecDisplay = UCase(audioStream.Codec)

                ' Show if audio is direct or transcoded
                if isValid(deviceSession.TranscodingInfo) and deviceSession.TranscodingInfo.Count() > 0
                    if deviceSession.TranscodingInfo.IsAudioDirect
                        audioCodecDisplay = audioCodecDisplay + " (" + tr("Direct") + ")"
                    else if isValid(deviceSession.TranscodingInfo.AudioCodec)
                        audioCodecDisplay = UCase(deviceSession.TranscodingInfo.AudioCodec) + " (" + tr("Transcoded from") + " " + UCase(audioStream.Codec) + ")"
                    end if
                end if

                sessionStats.data.push("<b>" + tr("Codec") + ":</b> " + audioCodecDisplay)
            end if

            if isValid(audioStream.Channels)
                channelLayout = Str(audioStream.Channels) + ".0"
                if audioStream.Channels = 6
                    channelLayout = "5.1"
                else if audioStream.Channels = 8
                    channelLayout = "7.1"
                end if
                sessionStats.data.push("<b>" + tr("Channels") + ":</b> " + channelLayout)
            end if

            if isValid(audioStream.SampleRate)
                sampleRateKHz = (audioStream.SampleRate / 1000.0)
                sessionStats.data.push("<b>" + tr("Sample Rate") + ":</b> " + formatFloat(sampleRateKHz, 1) + " kHz")
            end if

            if isValid(audioStream.BitRate)
                sessionStats.data.push("<b>" + tr("Bitrate") + ":</b> " + getDisplayBitrate(audioStream.BitRate))
            end if

            if isValid(audioStream.Language)
                sessionStats.data.push("<b>" + tr("Language") + ":</b> " + UCase(audioStream.Language))
            end if
        end if
    end if

    return sessionStats
end function

function havePlaybackInfo()
    if not isValid(m.playbackInfo)
        return false
    end if

    if not isValid(m.playbackInfo.mediaSources)
        return false
    end if

    if m.playbackInfo.mediaSources.Count() <= 0
        return false
    end if

    if not isValid(m.playbackInfo.mediaSources[0].MediaStreams)
        return false
    end if

    if m.playbackInfo.mediaSources[0].MediaStreams.Count() <= 0
        return false
    end if

    return true
end function

function getDisplayBitrate(bitrate)
    if bitrate > 1000000
        return Str(Fix(bitrate / 1000000)) + " Mbps"
    else
        return Str(Fix(bitrate / 1000)) + " Kbps"
    end if
end function

' Format a float value to a specific number of decimal places
' @param value - Float or dynamic value to format
' @param decimals - Number of decimal places
' @returns Formatted string representation
function formatFloat(value as dynamic, decimals as integer) as string
    if value = invalid then return "0"
    strVal = value.ToStr()
    dotPos = InStr(1, strVal, ".")
    if dotPos > 0 and decimals >= 0
        return Left(strVal, dotPos + decimals)
    end if
    return strVal
end function
