import "pkg:/source/utils/JellyseerrUtils.bs"

sub init()
    m.loadingGroup = m.top.findNode("loadingGroup")
    m.errorLabel = m.top.findNode("errorLabel")
    m.optionsContainer = m.top.findNode("optionsContainer")

    ' Server selector
    m.serverBg = m.top.findNode("serverBg")
    m.serverBgFocused = m.top.findNode("serverBgFocused")
    m.serverValueLabel = m.top.findNode("serverValueLabel")

    ' Profile selector
    m.profileBg = m.top.findNode("profileBg")
    m.profileBgFocused = m.top.findNode("profileBgFocused")
    m.profileValueLabel = m.top.findNode("profileValueLabel")

    ' Root folder selector
    m.rootFolderBg = m.top.findNode("rootFolderBg")
    m.rootFolderBgFocused = m.top.findNode("rootFolderBgFocused")
    m.rootFolderValueLabel = m.top.findNode("rootFolderValueLabel")

    ' Buttons
    m.submitBg = m.top.findNode("submitBg")
    m.submitBgFocused = m.top.findNode("submitBgFocused")
    m.cancelBg = m.top.findNode("cancelBg")
    m.cancelBgFocused = m.top.findNode("cancelBgFocused")

    ' API Task for fetching servers
    m.apiTask = CreateObject("roSGNode", "JellyseerrAPITask")

    ' Data arrays
    m.servers = []
    m.profiles = []
    m.rootFolders = []

    ' Selection indices
    m.selectedServerIndex = 0
    m.selectedProfileIndex = 0
    m.selectedRootFolderIndex = 0

    ' Focus state: 0=server, 1=profile, 2=rootFolder, 3=submit, 4=cancel
    m.focusedElement = 0

    ' Observe media type changes to fetch appropriate servers
    m.top.observeField("mediaType", "onMediaTypeChanged")
    m.top.observeField("is4k", "onIs4kChanged")

    ShowLoading()
    FetchServers()
end sub

sub onMediaTypeChanged()
    FetchServers()
end sub

sub onIs4kChanged()
    FetchServers()
end sub

sub ShowLoading()
    m.loadingGroup.visible = true
    m.optionsContainer.visible = false
    m.errorLabel.visible = false
end sub

sub HideLoading()
    m.loadingGroup.visible = false
    m.optionsContainer.visible = true
end sub

sub ShowError(message as string)
    m.loadingGroup.visible = false
    m.optionsContainer.visible = false
    m.errorLabel.text = message
    m.errorLabel.visible = true
end sub

sub FetchServers()
    mediaType = m.top.mediaType

    ' Determine which service to query based on media type
    if mediaType = "tv"
        endpoint = "/api/v1/service/sonarr"
    else
        endpoint = "/api/v1/service/radarr"
    end if


    m.apiTask.request = {
        method: "GET",
        endpoint: endpoint
    }

    m.apiTask.unobserveField("response")
    m.apiTask.observeField("response", "onServersReceived")
    m.apiTask.control = "RUN"
end sub

sub onServersReceived(event as object)
    response = event.getData()

    if not response.success
        ShowError("Failed to load servers. Please check your Jellyseerr configuration.")
        return
    end if

    data = response.data

    if data = invalid or type(data) <> "roArray" or data.count() = 0
        ShowError("No servers configured. Please configure Radarr/Sonarr in Jellyseerr.")
        return
    end if

    ' Filter servers by 4K status
    is4k = m.top.is4k
    m.servers = []

    for each server in data
        ' Server has is4k property indicating if it's a 4K server
        serverIs4k = false
        if server.is4k <> invalid
            serverIs4k = server.is4k
        end if

        if serverIs4k = is4k
            m.servers.push(server)
        end if
    end for

    if m.servers.count() = 0
        quality = "HD"
        if is4k then quality = "4K"
        ShowError("No " + quality + " servers configured. Please configure a " + quality + " server in Jellyseerr.")
        return
    end if

    ' Update server display
    m.selectedServerIndex = 0
    UpdateServerDisplay()

    ' Fetch details for the first server
    FetchServerDetails(m.servers[0].id)
end sub

sub FetchServerDetails(serverId as integer)
    mediaType = m.top.mediaType

    if mediaType = "tv"
        endpoint = "/api/v1/service/sonarr/" + serverId.toStr()
    else
        endpoint = "/api/v1/service/radarr/" + serverId.toStr()
    end if

    ' Create a new task for server details to avoid conflicts
    m.detailsTask = CreateObject("roSGNode", "JellyseerrAPITask")
    m.detailsTask.request = {
        method: "GET",
        endpoint: endpoint
    }

    m.detailsTask.observeField("response", "onServerDetailsReceived")
    m.detailsTask.control = "RUN"
end sub

sub onServerDetailsReceived(event as object)
    response = event.getData()

    if response.error <> invalid
        ShowError("Failed to load server details.")
        return
    end if

    if not response.success
        ShowError("Failed to load server details.")
        return
    end if

    data = response.data
    if data = invalid
        ShowError("Invalid server details received.")
        return
    end if


    ' Extract profiles
    m.profiles = []
    if data.profiles <> invalid and type(data.profiles) = "roArray"
        for each profile in data.profiles
            m.profiles.push(profile)
        end for
    end if

    ' Extract root folders
    m.rootFolders = []
    if data.rootFolders <> invalid and type(data.rootFolders) = "roArray"
        for each folder in data.rootFolders
            m.rootFolders.push(folder)
        end for
    end if

    ' Reset selection indices
    m.selectedProfileIndex = 0
    m.selectedRootFolderIndex = 0

    ' Update displays
    UpdateProfileDisplay()
    UpdateRootFolderDisplay()

    HideLoading()
    UpdateFocus()
end sub

sub UpdateServerDisplay()
    if m.servers.count() > 0 and m.selectedServerIndex < m.servers.count()
        server = m.servers[m.selectedServerIndex]
        name = server.name
        if name = invalid or name = ""
            name = "Server " + (m.selectedServerIndex + 1).toStr()
        end if
        m.serverValueLabel.text = name + " (" + (m.selectedServerIndex + 1).toStr() + "/" + m.servers.count().toStr() + ")"
    else
        m.serverValueLabel.text = "No servers available"
    end if
end sub

sub UpdateProfileDisplay()
    if m.profiles.count() > 0 and m.selectedProfileIndex < m.profiles.count()
        profile = m.profiles[m.selectedProfileIndex]
        name = profile.name
        if name = invalid or name = ""
            name = "Profile " + (m.selectedProfileIndex + 1).toStr()
        end if
        m.profileValueLabel.text = name + " (" + (m.selectedProfileIndex + 1).toStr() + "/" + m.profiles.count().toStr() + ")"
    else
        m.profileValueLabel.text = "Default Profile"
    end if
end sub

sub UpdateRootFolderDisplay()
    if m.rootFolders.count() > 0 and m.selectedRootFolderIndex < m.rootFolders.count()
        folder = m.rootFolders[m.selectedRootFolderIndex]
        path = folder.path
        if path = invalid or path = ""
            path = "Folder " + (m.selectedRootFolderIndex + 1).toStr()
        end if
        ' Shorten long paths
        if Len(path) > 50
            path = "..." + Right(path, 47)
        end if
        m.rootFolderValueLabel.text = path + " (" + (m.selectedRootFolderIndex + 1).toStr() + "/" + m.rootFolders.count().toStr() + ")"
    else
        m.rootFolderValueLabel.text = "Default Folder"
    end if
end sub

sub UpdateFocus()
    ' Reset all backgrounds
    m.serverBgFocused.visible = false
    m.serverBg.visible = true
    m.profileBgFocused.visible = false
    m.profileBg.visible = true
    m.rootFolderBgFocused.visible = false
    m.rootFolderBg.visible = true
    m.submitBgFocused.visible = false
    m.submitBg.visible = true
    m.cancelBgFocused.visible = false
    m.cancelBg.visible = true

    ' Highlight focused element
    if m.focusedElement = 0
        m.serverBgFocused.visible = true
        m.serverBg.visible = false
    else if m.focusedElement = 1
        m.profileBgFocused.visible = true
        m.profileBg.visible = false
    else if m.focusedElement = 2
        m.rootFolderBgFocused.visible = true
        m.rootFolderBg.visible = false
    else if m.focusedElement = 3
        m.submitBgFocused.visible = true
        m.submitBg.visible = false
    else if m.focusedElement = 4
        m.cancelBgFocused.visible = true
        m.cancelBg.visible = false
    end if
end sub

function onKeyEvent(key as string, press as boolean) as boolean
    if not press then return false

    if key = "up"
        if m.focusedElement > 0
            ' Handle button row (3 and 4 are on same row)
            if m.focusedElement = 3 or m.focusedElement = 4
                m.focusedElement = 2
            else
                m.focusedElement = m.focusedElement - 1
            end if
            UpdateFocus()
        end if
        return true
    else if key = "down"
        if m.focusedElement < 4
            if m.focusedElement = 2
                m.focusedElement = 3
            else
                m.focusedElement = m.focusedElement + 1
            end if
            UpdateFocus()
        end if
        return true
    else if key = "left"
        if m.focusedElement = 0
            ' Cycle server selection
            if m.servers.count() > 1
                m.selectedServerIndex = m.selectedServerIndex - 1
                if m.selectedServerIndex < 0
                    m.selectedServerIndex = m.servers.count() - 1
                end if
                UpdateServerDisplay()
                ' Fetch new server details
                FetchServerDetails(m.servers[m.selectedServerIndex].id)
            end if
        else if m.focusedElement = 1
            ' Cycle profile selection
            if m.profiles.count() > 1
                m.selectedProfileIndex = m.selectedProfileIndex - 1
                if m.selectedProfileIndex < 0
                    m.selectedProfileIndex = m.profiles.count() - 1
                end if
                UpdateProfileDisplay()
            end if
        else if m.focusedElement = 2
            ' Cycle root folder selection
            if m.rootFolders.count() > 1
                m.selectedRootFolderIndex = m.selectedRootFolderIndex - 1
                if m.selectedRootFolderIndex < 0
                    m.selectedRootFolderIndex = m.rootFolders.count() - 1
                end if
                UpdateRootFolderDisplay()
            end if
        else if m.focusedElement = 4
            ' Move to submit button
            m.focusedElement = 3
            UpdateFocus()
        end if
        return true
    else if key = "right"
        if m.focusedElement = 0
            ' Cycle server selection
            if m.servers.count() > 1
                m.selectedServerIndex = (m.selectedServerIndex + 1) mod m.servers.count()
                UpdateServerDisplay()
                ' Fetch new server details
                FetchServerDetails(m.servers[m.selectedServerIndex].id)
            end if
        else if m.focusedElement = 1
            ' Cycle profile selection
            if m.profiles.count() > 1
                m.selectedProfileIndex = (m.selectedProfileIndex + 1) mod m.profiles.count()
                UpdateProfileDisplay()
            end if
        else if m.focusedElement = 2
            ' Cycle root folder selection
            if m.rootFolders.count() > 1
                m.selectedRootFolderIndex = (m.selectedRootFolderIndex + 1) mod m.rootFolders.count()
                UpdateRootFolderDisplay()
            end if
        else if m.focusedElement = 3
            ' Move to cancel button
            m.focusedElement = 4
            UpdateFocus()
        end if
        return true
    else if key = "OK"
        if m.focusedElement = 3
            ' Submit button pressed
            SubmitSelection()
        else if m.focusedElement = 4
            ' Cancel button pressed
            m.top.wasCancelled = true
        end if
        return true
    else if key = "back"
        m.top.wasCancelled = true
        return true
    end if

    return false
end function

sub SubmitSelection()
    ' Set selected IDs
    if m.servers.count() > 0 and m.selectedServerIndex < m.servers.count()
        m.top.selectedServerId = m.servers[m.selectedServerIndex].id
    end if

    if m.profiles.count() > 0 and m.selectedProfileIndex < m.profiles.count()
        m.top.selectedProfileId = m.profiles[m.selectedProfileIndex].id
    end if

    if m.rootFolders.count() > 0 and m.selectedRootFolderIndex < m.rootFolders.count()
        folder = m.rootFolders[m.selectedRootFolderIndex]
        m.top.selectedRootFolderId = folder.id
        if folder.path <> invalid
            m.top.selectedRootFolderPath = folder.path
        end if
    end if

    m.top.wasSubmitted = true
end sub
