import "pkg:/source/enums/ColorPalette.bs"
import "pkg:/source/utils/misc.bs"

sub init()
    ' Get UI elements - will be created when XML is loaded
    m.title = invalid
    m.subtitle = invalid
    m.seasonList = invalid
    m.okButton = invalid
    m.cancelButton = invalid

    ' Track checked state manually
    m.checkedState = []
    m.focusedElement = "list" ' "list", "ok", "cancel"

    ' Observe field changes to build the list
    m.top.observeField("numberOfSeasons", "onFieldsReady")
    m.top.observeField("showName", "onFieldsReady")
    m.top.observeField("is4k", "onFieldsReady")
end sub

sub onFieldsReady()
    ' Lazy init UI elements
    if m.title = invalid
        m.title = m.top.findNode("title")
        m.subtitle = m.top.findNode("subtitle")
        m.seasonList = m.top.findNode("seasonList")
        m.okButton = m.top.findNode("okButton")
        m.cancelButton = m.top.findNode("cancelButton")

        ' Style the list
        if m.seasonList <> invalid
            m.seasonList.focusBitmapBlendColor = chainLookupReturn(m.global.session, "user.settings.colorCursor", ColorPalette.HIGHLIGHT)
            m.seasonList.focusFootprintBlendColor = "0x6366F199"
            m.seasonList.color = "0xE5E7EB"
            m.seasonList.focusedColor = "0xFFFFFF"
        end if

        ' Get button backgrounds for focus styling
        if m.okButton <> invalid
            m.okButtonBg = m.okButton.findNode("okButtonBg")
        end if

        if m.cancelButton <> invalid
            m.cancelButtonBg = m.cancelButton.findNode("cancelButtonBg")
        end if
    end if

    ' Update subtitle and build list when we have all data
    if m.top.showName <> "" and m.top.numberOfSeasons > 0
        updateSubtitle()
        buildSeasonList()
    end if
end sub

' Update the subtitle with show name and quality with better formatting
sub updateSubtitle()
    if m.subtitle = invalid then return
    if m.top.showName <> ""
        quality = "HD"
        if m.top.is4k then quality = "4K"
        m.subtitle.text = m.top.showName + "  •  " + quality
    end if
end sub

' Build the list of seasons with checkbox icons in titles
sub buildSeasonList()
    if m.seasonList = invalid then return

    numSeasons = m.top.numberOfSeasons
    if numSeasons = invalid or numSeasons <= 0 then return

    ' Get unavailable seasons array
    unavailableSeasons = m.top.unavailableSeasons
    if unavailableSeasons = invalid then unavailableSeasons = []

    ' Build set of unavailable season numbers for fast lookup
    m.unavailableSeasonsSet = {}
    for each seasonNum in unavailableSeasons
        if seasonNum <> invalid and GetInterface(seasonNum, "ifInt") <> invalid
            m.unavailableSeasonsSet[seasonNum.toStr()] = true
        end if
    end for

    ' Initialize checked state: unchecked for unavailable, checked for available
    m.checkedState = []
    ' Index 0 is for "Select All" - only check if there are any available seasons
    hasAvailable = false
    for i = 1 to numSeasons
        if not isSeasonUnavailable(i)
            hasAvailable = true
            exit for
        end if
    end for
    m.checkedState.push(hasAvailable)

    ' Index 1 to numSeasons for individual seasons
    for i = 1 to numSeasons
        ' Unavailable seasons are unchecked and disabled
        if isSeasonUnavailable(i)
            m.checkedState.push(false)
        else
            m.checkedState.push(true)
        end if
    end for

    ' Build list content with checkbox characters in title
    updateListContent()

    ' Set initial focus on the dialog itself, then the list
    m.top.setFocus(true)
    m.seasonList.setFocus(true)
    m.focusedElement = "list"
end sub

' Check if a season is unavailable (already requested/available)
function isSeasonUnavailable(seasonNumber as integer) as boolean
    if m.unavailableSeasonsSet = invalid then return false
    return m.unavailableSeasonsSet[seasonNumber.toStr()] = true
end function

' Update button focus styling
sub updateButtonFocus()
    userColor = chainLookupReturn(m.global.session, "user.settings.colorCursor", ColorPalette.HIGHLIGHT)

    if m.focusedElement = "ok"
        if m.okButtonBg <> invalid
            m.okButtonBg.blendColor = userColor
        end if
        if m.cancelButtonBg <> invalid
            m.cancelButtonBg.blendColor = "0x4B5563FF"
        end if
    else if m.focusedElement = "cancel"
        if m.okButtonBg <> invalid
            m.okButtonBg.blendColor = "0x4B5563FF"
        end if
        if m.cancelButtonBg <> invalid
            m.cancelButtonBg.blendColor = "0xEF4444FF"
        end if
    else
        ' List has focus - default colors
        if m.okButtonBg <> invalid
            m.okButtonBg.blendColor = "0x4B5563FF"
        end if
        if m.cancelButtonBg <> invalid
            m.cancelButtonBg.blendColor = "0x4B5563FF"
        end if
    end if
end sub

' Update list content to reflect current checked state with better styling
sub updateListContent()
    if m.seasonList = invalid then return

    numSeasons = m.top.numberOfSeasons
    ' Save current focus position
    currentIndex = 0
    if m.seasonList.content <> invalid and m.seasonList.itemFocused <> invalid
        currentIndex = m.seasonList.itemFocused
    end if

    content = CreateObject("roSGNode", "ContentNode")

    ' Check if there are any available seasons
    hasAvailable = false
    for i = 1 to numSeasons
        if not isSeasonUnavailable(i)
            hasAvailable = true
            exit for
        end if
    end for

    ' Add "Select All" option first (only if there are available seasons)
    selectAllNode = content.CreateChild("ContentNode")
    if hasAvailable
        checkmark = getCheckboxChar(m.checkedState[0])
        ' Determine if all unavailable or some available
        allUnavailable = true
        for i = 1 to numSeasons
            if not isSeasonUnavailable(i)
                allUnavailable = false
                exit for
            end if
        end for
        if allUnavailable
            selectAllNode.title = "    All Seasons Requested"
        else
            selectAllNode.title = checkmark + "  Select All Available"
        end if
    else
        selectAllNode.title = "    All Seasons Already Requested"
    end if

    ' Add individual season options with cleaner formatting
    for i = 1 to numSeasons
        seasonNode = content.CreateChild("ContentNode")
        if isSeasonUnavailable(i)
            ' Show as unavailable (no checkbox, grayed appearance via title)
            seasonNode.title = "    Season " + i.toStr() + "  (Already Requested)"
        else
            checkmark = getCheckboxChar(m.checkedState[i])
            seasonNode.title = checkmark + "   Season " + i.toStr()
        end if
    end for

    ' Set content first, then restore focus position
    m.seasonList.content = content
    m.seasonList.jumpToItem = currentIndex
end sub

' Get checkbox character based on state with better visuals
function getCheckboxChar(isChecked as boolean) as string
    if isChecked
        return "[✓]"
    else
        return "[ ]"
    end if
end function

' Toggle checkbox at given index
sub toggleCheckbox(index as integer)
    if index < 0 or index >= m.checkedState.Count() then return

    numSeasons = m.top.numberOfSeasons

    ' If Select All was toggled (index 0), only toggle available seasons
    if index = 0
        ' Check if there are any available seasons
        hasAvailable = false
        for i = 1 to numSeasons
            if not isSeasonUnavailable(i)
                hasAvailable = true
                exit for
            end if
        end for
        if not hasAvailable then return ' Nothing to toggle

        ' Toggle the Select All state
        m.checkedState[index] = not m.checkedState[index]

        ' Sync all available seasons to Select All state
        for i = 1 to numSeasons
            if not isSeasonUnavailable(i)
                m.checkedState[i] = m.checkedState[0]
            end if
        end for
    else
        ' Individual season - check if it's unavailable
        if isSeasonUnavailable(index)
            ' Don't toggle unavailable seasons
            return
        end if

        ' Toggle the state
        m.checkedState[index] = not m.checkedState[index]

        ' Update Select All checkbox to reflect current state
        updateSelectAllState()
    end if

    ' Update the display
    updateListContent()
end sub

' Update the Select All checkbox state based on available seasons
sub updateSelectAllState()
    numSeasons = m.top.numberOfSeasons
    allAvailableChecked = true

    for i = 1 to numSeasons
        if not isSeasonUnavailable(i)
            if not m.checkedState[i]
                allAvailableChecked = false
                exit for
            end if
        end if
    end for

    m.checkedState[0] = allAvailableChecked
end sub

function onKeyEvent(key as string, press as boolean) as boolean
    if not press then return false

    if key = "back"
        m.top.wasCancelled = true
        return true
    end if

    if m.focusedElement = "list"
        if key = "OK"
            ' Toggle checkbox at current position
            if m.seasonList <> invalid
                toggleCheckbox(m.seasonList.itemFocused)
            end if
            return true
        else if key = "down"
            if m.seasonList <> invalid
                itemFocused = m.seasonList.itemFocused
                itemCount = m.seasonList.content.getChildCount()

                if itemFocused < itemCount - 1
                    m.seasonList.itemFocused = itemFocused + 1
                else
                    ' At bottom, move to OK button
                    m.focusedElement = "ok"
                    if m.okButton <> invalid
                        m.okButton.setFocus(true)
                    end if
                    updateButtonFocus()
                end if
            end if
            return true
        else if key = "up"
            if m.seasonList <> invalid
                itemFocused = m.seasonList.itemFocused

                if itemFocused > 0
                    m.seasonList.itemFocused = itemFocused - 1
                end if
                ' At top - do nothing
            end if
            return true
        end if
    else if m.focusedElement = "ok"
        if key = "OK"
            submitSelection()
            return true
        else if key = "up"
            ' Go back to list at last item
            m.focusedElement = "list"
            if m.seasonList <> invalid
                itemCount = m.seasonList.content.getChildCount()
                m.seasonList.itemFocused = itemCount - 1
                m.seasonList.setFocus(true)
            end if
            updateButtonFocus()
            return true
        else if key = "right"
            m.focusedElement = "cancel"
            if m.cancelButton <> invalid
                m.cancelButton.setFocus(true)
            end if
            updateButtonFocus()
            return true
        end if
    else if m.focusedElement = "cancel"
        if key = "OK"
            m.top.wasCancelled = true
            return true
        else if key = "up"
            ' Go back to list at last item
            m.focusedElement = "list"
            if m.seasonList <> invalid
                itemCount = m.seasonList.content.getChildCount()
                m.seasonList.itemFocused = itemCount - 1
                m.seasonList.setFocus(true)
            end if
            updateButtonFocus()
            return true
        else if key = "left"
            m.focusedElement = "ok"
            if m.okButton <> invalid
                m.okButton.setFocus(true)
            end if
            updateButtonFocus()
            return true
        end if
    end if

    return true
end function

sub submitSelection()
    numSeasons = m.top.numberOfSeasons

    ' Build array of selected season numbers (only from available seasons)
    selectedSeasons = []

    ' Count how many seasons are available
    availableCount = 0
    for i = 1 to numSeasons
        if not isSeasonUnavailable(i)
            availableCount = availableCount + 1
        end if
    end for

    ' If no seasons are available, cancel
    if availableCount = 0
        m.top.wasCancelled = true
        return
    end if

    ' Check indices 1-N for seasons 1-N (only available ones)
    for i = 1 to numSeasons
        if not isSeasonUnavailable(i) and i < m.checkedState.Count() and m.checkedState[i] = true
            selectedSeasons.push(i)
        end if
    end for

    if selectedSeasons.Count() = 0
        ' Nothing selected, cancel
        m.top.wasCancelled = true
        return
    end if

    ' If all available seasons are selected and Select All is checked,
    ' return empty array to signal "all available seasons"
    if m.checkedState[0] = true and selectedSeasons.Count() = availableCount
        m.top.selectedSeasons = []
    else
        m.top.selectedSeasons = selectedSeasons
    end if
end sub

sub onOkButtonSelected()
    submitSelection()
end sub

sub onCancelButtonSelected()
    m.top.wasCancelled = true
end sub
