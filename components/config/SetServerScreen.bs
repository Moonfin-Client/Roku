import "pkg:/source/enums/ColorPalette.bs"
import "pkg:/source/enums/KeyCode.bs"
import "pkg:/source/enums/TaskControl.bs"
import "pkg:/source/utils/config.bs"
import "pkg:/source/utils/misc.bs"

sub init()
    print "ðŸ”µ [SetServerScreen] init() called"
    m.top.optionsAvailable = false
    m.top.setFocus(true)

    m.serverPicker = m.top.findNode("serverPicker")
    m.serverUrlTextbox = m.top.findNode("serverUrlTextbox")
    m.serverUrlContainer = m.top.findNode("serverUrlContainer")
    m.serverPickerContainer = m.top.findNode("serverPickerContainer")
    m.serverUrlOutline = m.top.findNode("serverUrlOutline")
    m.serverUrlOutline.blendColor = "0x00A4DCFF" ' Blue focus

    m.serverPickerContainer.color = ColorPalette.ELEMENTBACKGROUND
    m.serverUrlContainer.color = ColorPalette.BLACK77

    ' Set text input colors
    m.serverUrlTextbox.textColor = ColorPalette.DARKGREY
    m.serverUrlTextbox.hintTextColor = ColorPalette.MIDGREY
    m.serverUrlTextbox.observeField("text", "onServerUrlTextChanged")

    m.submit = m.top.findNode("submit")
    print "ðŸ”µ [SetServerScreen] submit button found: " + (m.submit <> invalid).toStr()
    m.submit.background = "0x292929FF" ' Dark grey
    m.submit.color = "0xFFFFFFFF" ' White text
    m.submit.focusBackground = "0x00A4DCFF" ' Blue on focus
    m.submit.focusColor = "0xFFFFFFFF" ' White text

    m.top.observeField("serverUrl", "clearErrorMessage")

    print "ðŸ”µ [SetServerScreen] init() complete, calling ScanForServers()"
    ScanForServers()
end sub

sub onServerUrlTextChanged()
    ' Change text color to white if there's text, otherwise grey for placeholder
    if m.serverUrlTextbox.text <> "" and m.serverUrlTextbox.text <> invalid
        m.serverUrlTextbox.textColor = ColorPalette.WHITE
    else
        m.serverUrlTextbox.textColor = ColorPalette.DARKGREY
    end if
end sub

function onKeyEvent(key as string, press as boolean) as boolean
    print "ðŸ”µ [SetServerScreen] onKeyEvent: key=" + key + " press=" + press.toStr()
    if not press then return true

    if key = KeyCode.RIGHT
        print "ðŸ”µ [SetServerScreen] RIGHT key pressed"
        if m.serverPicker.hasFocus()
            print "ðŸ”µ [SetServerScreen] serverPicker has focus"
            selectedServer = m.serverPicker.content.getChild(m.serverPicker.itemFocused)
            if chainLookupReturn(selectedServer, "isSavedServer", false)
                selectedServer.itemHasDeleteFocus = true
                return true
            end if
        end if
    end if

    if key = KeyCode.LEFT
        print "ðŸ”µ [SetServerScreen] LEFT key pressed"
        if m.serverPicker.hasFocus()
            selectedServer = m.serverPicker.content.getChild(m.serverPicker.itemFocused)
            if isValid(selectedServer)
                selectedServer.itemHasDeleteFocus = false
            end if
            return true
        end if
    end if

    if key = KeyCode.OK
        print "ðŸ”µ [SetServerScreen] OK key pressed"
        print "ðŸ”µ [SetServerScreen] serverPicker.hasFocus()=" + m.serverPicker.hasFocus().toStr()
        print "ðŸ”µ [SetServerScreen] submit.hasFocus()=" + m.submit.hasFocus().toStr()
        print "ðŸ”µ [SetServerScreen] serverUrlContainer.hasFocus()=" + m.serverUrlContainer.hasFocus().toStr()

        if m.serverPicker.hasFocus()
            print "ðŸ”µ [SetServerScreen] OK on serverPicker - selecting server"
            selectedServer = m.serverPicker.content.getChild(m.serverPicker.itemFocused)

            if chainLookupReturn(selectedServer, "itemHasDeleteFocus", false)
                m.top.forgetServer = selectedServer.baseUrl
                return true
            end if

            m.top.serverUrl = selectedServer.baseUrl
            print "ðŸ”µ [SetServerScreen] set serverUrl to: " + m.top.serverUrl
            m.submit.setFocus(true)
            m.submit.focus = true
            return true
        end if

        if m.submit.hasFocus()
            print "ðŸ”µ [SetServerScreen] OK on submit button - button will handle via onKeyEvent"
            ' Let the StandardButton's onKeyEvent handle this - it sets buttonSelected
            return false
        end if

        if m.serverUrlContainer.hasFocus()
            print "ðŸ”µ [SetServerScreen] OK on serverUrlContainer - showing keyboard"
            ShowKeyboard()
            return true
        end if

        print "ðŸ”µ [SetServerScreen] OK key - nothing had focus, returning false"
        return false
    end if

    if key = KeyCode.DOWN
        if m.serverPicker.hasFocus() and m.serverPicker.content.getChildCount() > 0 and m.serverPicker.itemFocused = m.serverPicker.content.getChildCount() - 1
            m.serverUrlContainer.setFocus(true)
            m.serverUrlOutline.visible = true
            return true
        end if

        if m.serverUrlContainer.hasFocus()
            m.serverUrlOutline.visible = false
            m.submit.setFocus(true)
            m.submit.focus = true
            return true
        end if

        return false
    end if

    if key = KeyCode.UP
        if m.serverUrlContainer.hasFocus() and isValidAndNotEmpty(m.servers)
            m.serverPicker.setFocus(true)
            m.serverUrlOutline.visible = false
            return true
        end if

        if m.serverUrlContainer.hasFocus() and m.servers.Count() = 0
            ScanForServers()
            m.serverUrlOutline.visible = false
            return true
        end if

        if m.submit.hasFocus()
            m.serverUrlContainer.setFocus(true)
            m.serverUrlOutline.visible = true
            m.submit.focus = false
            return true
        end if

        return false
    end if

    if key = KeyCode.BACK
        if m.serverUrlContainer.hasFocus() and isValidAndNotEmpty(m.servers)
            m.serverUrlOutline.visible = false
            m.serverPicker.setFocus(true)
            return true
        end if

        if m.submit.hasFocus() and isValidAndNotEmpty(m.servers)
            m.serverPicker.setFocus(true)
            return true
        end if

        if m.submit.hasFocus() and m.servers.Count() = 0
            m.serverUrlOutline.visible = true
            m.serverUrlContainer.setFocus(true)
            return true
        end if

        if m.serverUrlContainer.hasFocus() and m.servers.Count() = 0
            ScanForServers()
            return true
        end if

        if m.serverPicker.hasFocus() and isValidAndNotEmpty(m.servers)
            ScanForServers()
            return true
        end if

        return false
    end if

    return false
end function

sub ScanForServers()
    print "ðŸ”µ [SetServerScreen] ScanForServers() called"
    m.ssdpScanner = CreateObject("roSGNode", "ServerDiscoveryTask")
    m.ssdpScanner.observeField("content", "ScanForServersComplete")
    m.ssdpScanner.control = TaskControl.RUN
    startLoadingSpinner(false)
end sub

sub ScanForServersComplete(event)
    print "ðŸ”µ [SetServerScreen] ScanForServersComplete() called"
    m.servers = event.getData()
    print "ðŸ”µ [SetServerScreen] Found " + m.servers.Count().toStr() + " servers"

    items = CreateObject("roSGNode", "ServerData")
    for each server in m.servers
        server.isSavedServer = false
        server.subtype = "ServerData"
        'add new fields for every server property onto the ContentNode (rather than making a dedicated component just to hold data...)
        items.update([server], true)
    end for

    'load any previously logged in to servers as well (if they aren't already discovered on the local network)
    saved = get_setting("saved_servers")
    if isValid(saved)
        savedServers = ParseJson(saved)
        for each server in savedServers.serverList
            alreadyListed = false
            for each listed in m.servers
                if LCase(listed.baseUrl) = server.baseUrl 'saved server data is always lowercase
                    alreadyListed = true
                    exit for
                end if
            end for
            if alreadyListed = false
                server.isSavedServer = true
                items.update([server], true)
                m.servers.push(server)
            end if
        end for
    end if

    m.serverPicker.content = items
    stopLoadingSpinner()

    print "ðŸ”µ [SetServerScreen] ScanForServersComplete - total servers: " + m.servers.Count().toStr()

    'if we have at least one server, focus on the server picker
    if m.servers.Count() > 0
        print "ðŸ”µ [SetServerScreen] Focusing on serverPicker"
        m.serverPicker.setFocus(true)
        'no servers found...focus on the input textbox
    else
        print "ðŸ”µ [SetServerScreen] No servers found, focusing on serverUrlContainer"
        m.serverUrlContainer.setFocus(true)
        'show/hide input box outline
        m.serverUrlOutline.visible = true
    end if

end sub

sub ShowKeyboard()
    dialog = createObject("roSGNode", "StandardKeyboardDialog")
    dialog.title = tr("Enter the server name or ip address")
    dialog.buttons = [tr("OK"), tr("Cancel")]
    dialog.text = m.serverUrlTextbox.text

    palette = createObject("roSGNode", "RSGPalette")
    palette.colors = { DialogBackgroundColor: ColorPalette.ELEMENTBACKGROUND }
    dialog.palette = palette

    m.top.getscene().dialog = dialog
    m.dialog = dialog

    dialog.observeField("buttonSelected", "onDialogButton")
end sub

function onDialogButton()
    d = m.dialog
    button_text = d.buttons[d.buttonSelected]

    if button_text = tr("OK")
        m.serverUrlTextbox.text = d.text
        m.dialog.close = true
        return true
    else if button_text = tr("Cancel")
        m.dialog.close = true
        return true
    else
        return false
    end if
end function

sub clearErrorMessage()
    m.top.errorMessage = ""
end sub
