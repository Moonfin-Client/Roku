import "pkg:/source/enums/ItemType.bs"
import "pkg:/source/enums/PersonType.bs"
import "pkg:/source/utils/misc.bs"

sub init()
    m.extrasType = {
        BEHINDTHESCENES: "Behind the Scenes",
        CLIP: "Clip",
        DELETEDSCENE: "Deleted Scene",
        FEATURETTE: "Featurette",
        INTERVIEW: "Interview",
        SAMPLE: "Sample",
        SCENE: "Scene",
        SHORT: "Short",
        THEMESONG: "ThemeSong",
        THEMEVIDEO: "ThemeVideo",
        TRAILER: "Trailer",
        UNKNOWN: "Extra"
    }

    initPosterImg()
    initName()
    initRole()

    ' Initialize nodes for both circular and rectangular posters
    m.photoCircle = m.top.findNode("photoCircle")
    m.posterImgRect = m.top.findNode("posterImgRect")
    m.playedIndicator = m.top.findNode("playedIndicator")
    m.scaleGroup = m.top.findNode("scaleGroup")
    m.focusAnimation = m.top.findNode("focusAnimation")
    m.unfocusAnimation = m.top.findNode("unfocusAnimation")

    m.name.height = 34
    m.name.font.size = 25
    m.name.horizAlign = "left"
    m.name.vertAlign = "bottom"

    m.role.font.size = 22
end sub

sub initPosterImg()
    m.posterImg = m.top.findNode("posterImg")
end sub

sub initName()
    m.name = m.top.findNode("pLabel")
end sub

sub initRole()
    m.role = m.top.findNode("subTitle")
end sub

sub showContent()
    ' validate nodes to prevent crash
    if not isValid(m.posterImg) then initPosterImg()
    if not isValid(m.name) then initName()
    if not isValid(m.role) then initRole()

    if isValid(m.top.itemContent)
        cont = m.top.itemContent

        m.name.text = cont.labelText
        m.name.maxWidth = cont.imageWidth

        ' Determine if this is a person (circular) or movie/show (rectangular)
        isPerson = isStringEqual(cont.LookupCI("type"), PersonType.PERSON)

        if isPerson
            ' Show circular poster for cast/crew
            m.photoCircle.visible = true
            m.posterImgRect.visible = false
            m.posterImg.uri = cont.posterURL

            ' MaskGroup handles circular cropping, no need for oversizing
            imageSize = 250
            m.posterImg.width = imageSize
            m.posterImg.height = imageSize

            ' Position text below circular image (adjusted for translation)
            m.name.translation = [0, 281]
            m.role.translation = [0, 321]
        else
            ' Show rectangular poster for movies/shows/episodes
            m.photoCircle.visible = false
            m.posterImgRect.visible = true
            m.posterImgRect.uri = cont.posterURL

            ' Determine display mode based on content type
            ' Use scaleToFit for movies, series, and seasons to show full poster
            ' Use scaleToZoom for episodes to crop screenshot
            isMovie = isValid(cont.Type) and (cont.Type = "Movie" or cont.Type = "Series" or cont.Type = "Season")
            isNextEpisode = isValid(cont.json) and isValid(cont.json.NextEpisode) and cont.json.NextEpisode
            if isMovie or isNextEpisode
                m.posterImgRect.loadDisplayMode = "scaleToFit"
            else
                m.posterImgRect.loadDisplayMode = "scaleToZoom"
            end if

            ' Set played indicator if watched
            if isValid(m.playedIndicator) and isValid(cont.json)
                if hasValidProperties(cont.json, "UserData", "Played")
                    m.playedIndicator.visible = cont.json.UserData.Played
                end if
            end if

            ' Dynamically set poster size based on imageWidth
            if isValid(cont.imageWidth)
                posterWidth = cont.imageWidth
                ' Calculate height based on aspect ratio
                ' For wide episodes (16:9): 450x253
                ' For portrait (2:3): 234x351
                if posterWidth >= 400
                    ' Wide format (16:9 ratio)
                    posterHeight = int(posterWidth * 0.5625)
                else
                    ' Portrait format (2:3 ratio)
                    posterHeight = int(posterWidth * 1.5)
                end if

                m.posterImgRect.width = posterWidth
                m.posterImgRect.height = posterHeight

                ' Position text below poster (poster height + 23px spacing to match scaleGroup offset)
                m.name.translation = [0, posterHeight + 31]
                m.role.translation = [0, posterHeight + 71]

                ' Adjust played indicator position for wide images
                if posterWidth >= 400
                    m.playedIndicator.translation = [posterWidth - 60, 0]
                else
                    m.playedIndicator.translation = [174, 0]
                end if
            else
                ' Default to portrait poster size
                m.posterImgRect.width = 234
                m.posterImgRect.height = 351
                m.name.translation = [0, 382]
                m.role.translation = [0, 422]
                m.playedIndicator.translation = [174, 0]
            end if

            ' Handle music videos differently
            if isStringEqual(cont.LookupCI("type"), ItemType.MUSICVIDEO)
                m.name.maxWidth = 400
                m.role.maxWidth = 400
            end if
        end if

        if isChainValid(cont, "json.ExtraType")
            if cont.json.ExtraType <> ""
                cont.subTitle = m.extrasType[UCase(cont.json.ExtraType)]
            end if
        end if

        if isChainValid(cont, "json.officialrating")
            if cont.json.officialrating <> ""
                cont.subTitle += ` - ${cont.json.officialrating}`
            end if
        end if

        m.role.Text = cont.subTitle.trim()
    else
        m.role.text = tr("Unknown")
        m.posterImg.uri = "pkg:/images/baseline_person_white_48dp.png"
    end if
end sub

sub focusChanged()
    ' Enable text scrolling on focus
    m.name.repeatCount = m.top.itemHasFocus ? - 1 : 0

    ' Handle focus/unfocus animations
    if m.top.itemHasFocus
        if isValid(m.focusAnimation)
            m.unfocusAnimation.control = "stop"
            m.focusAnimation.control = "start"
        end if
    else
        if isValid(m.unfocusAnimation)
            m.focusAnimation.control = "stop"
            m.unfocusAnimation.control = "start"
        end if
    end if

    if isValid(m.global) and isValid(m.global.device) and m.global.device.isAudioGuideEnabled = true
        txt2Speech = CreateObject("roTextToSpeech")
        txt2Speech.Flush()
        txt2Speech.Say(m.name.text)
        txt2Speech.Say(m.role.text)
    end if
end sub
