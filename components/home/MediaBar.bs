import "pkg:/source/api/Image.bs"
import "pkg:/source/enums/KeyCode.bs"
import "pkg:/source/utils/misc.bs"

sub init()
    m.logoImage = m.top.findNode("logoImage")
    m.logoShadow = m.top.findNode("logoShadow")
    m.titleText = m.top.findNode("titleText")
    m.yearLabel = m.top.findNode("yearLabel")
    m.ratingLabel = m.top.findNode("ratingLabel")
    m.runtimeLabel = m.top.findNode("runtimeLabel")
    m.starLabel = m.top.findNode("starLabel")
    m.communityRatingLabel = m.top.findNode("communityRatingLabel")
    m.genresLabel = m.top.findNode("genresLabel")
    m.overviewLabel = m.top.findNode("overviewLabel")
    m.leftArrow = m.top.findNode("leftArrow")
    m.rightArrow = m.top.findNode("rightArrow")
    m.indicatorDots = m.top.findNode("indicatorDots")
    m.pauseIndicator = m.top.findNode("pauseIndicator")
    m.infoOverlayContent = m.top.findNode("infoOverlayContent")
    m.infoBackground = m.top.findNode("infoBackground")
    m.dotsBackground = m.top.findNode("dotsBackground")

    ' Arrow background elements
    m.leftArrowBg = m.top.findNode("leftArrowBg")
    m.rightArrowBg = m.top.findNode("rightArrowBg")

    ' Separator dots for metadata
    m.separatorDot1 = m.top.findNode("separatorDot1")
    m.separatorDot2 = m.top.findNode("separatorDot2")
    m.separatorDot3 = m.top.findNode("separatorDot3")
    m.separatorDot4 = m.top.findNode("separatorDot4")

    ' Content fade animations
    m.contentFadeOut = m.top.findNode("contentFadeOut")
    m.contentFadeIn = m.top.findNode("contentFadeIn")
    m.infoBgFadeInInterp = m.top.findNode("infoBgFadeInInterp")
    m.logoShadowFadeInInterp = m.top.findNode("logoShadowFadeInInterp")
    m.pendingDisplayIndex = -1
    if isValid(m.contentFadeOut)
        m.contentFadeOut.observeFieldScoped("state", "onContentFadeOutComplete")
    end if

    ' Initialize state
    m.mediaBarItems = []
    m.currentIndex = 0
    m.isPaused = false
    m.clearBackdrop = false

    ' Make component focusable
    m.top.focusable = true

    ' Observe visibility changes to refresh display when shown
    m.top.observeFieldScoped("visible", "onVisibilityChanged")

    ' Observe focus changes to ensure backdrop is set on initial focus
    m.top.observeFieldScoped("hasFocus", "onFocusChanged")

    ' Observe overlay settings changes
    if isValid(m.global)
        m.global.observeFieldScoped("overlaySettingsChanged", "onOverlaySettingsChanged")
    end if

    ' Apply UI overlay settings
    applyOverlaySettings()

    ' Load media items
    loadMediaBarItems()
end sub

' Handle focus changes - ensure backdrop is set when component gets focus
sub onFocusChanged(event as object)
    hasFocus = event.getData()

    if hasFocus and m.mediaBarItems.count() > 0
        ' Immediately refresh display when focus is gained
        displayMediaBarItem(m.currentIndex)
        ' Resume auto-advance timer
        if isValid(m.autoAdvanceTimer)
            m.autoAdvanceTimer.control = "start"
        end if
    else
        if m.clearBackdrop
            ' Clear backdrop when focus is lost (if allowed)
            m.top.currentBackdrop = "" ' Clear backdrop on focus loss
            m.clearBackdrop = false ' reset flag
        end if
        ' Stop auto-advance timer when losing focus (e.g., navigating to navbar)
        if isValid(m.autoAdvanceTimer)
            m.autoAdvanceTimer.control = "stop"
        end if
    end if
end sub

' Handle visibility changes - refresh display when component becomes visible
sub onVisibilityChanged(event as object)
    isVisible = event.getData()

    if isVisible and m.mediaBarItems.count() > 0
        ' Refresh the current item display when component becomes visible
        displayMediaBarItem(m.currentIndex)
    end if
end sub

' Handle overlay settings changes
sub onOverlaySettingsChanged(_event as object)
    applyOverlaySettings()
end sub

' Apply opacity and color settings to overlay elements
sub applyOverlaySettings()
    if not isValid(m.global) or not isValid(m.global.session) then return

    opacitySetting = chainLookupReturn(m.global.session, "user.settings.`ui.overlayOpacity`", invalid)
    opacity = isValid(opacitySetting) ? opacitySetting.toFloat() : 0.5

    ' Store for use in fade animations
    m.overlayOpacity = opacity

    colorSetting = chainLookupReturn(m.global.session, "user.settings.`ui.overlayColor`", "")
    color = isValidAndNotEmpty(colorSetting) ? colorSetting + "FF" : "0x475569FF"

    for each element in [m.infoBackground, m.dotsBackground, m.leftArrowBg, m.rightArrowBg]
        if isValid(element)
            element.opacity = opacity
            element.blendColor = color
        end if
    end for
end sub

' Fetch and prepare media items
sub loadMediaBarItems()
    ' Create and configure task to fetch data from API
    m.mediaBarTask = createObject("roSGNode", "MediaBarTask")
    m.mediaBarTask.userId = m.global.session.user.id
    m.mediaBarTask.observeFieldScoped("mediaBarData", "onMediaBarDataLoaded")
    m.mediaBarTask.control = "RUN"
end sub

' Handle data loaded from task
sub onMediaBarDataLoaded(event as object)
    data = event.getData()
    if not isValid(data)
        return
    end if

    ' Clean up task observer now that we have the data
    if isValid(m.mediaBarTask)
        m.mediaBarTask.unobserveFieldScoped("mediaBarData")
    end if

    allItems = isChainValid(data, "items") ? data.items : []

    ' Filter items that have backdrop images
    itemsWithBackdrops = []
    for each item in allItems
        if isChainValid(item, "backdropImageTags") and item.backdropImageTags.count() > 0
            itemsWithBackdrops.push(processItem(item))
        end if
    end for

    settingValue = chainLookupReturn(m.global.session, "user.settings.`ui.home.featuredMediaItems`", invalid)
    carouselItemCount = isValid(settingValue) ? settingValue.toInt() : 15

    ' Shuffle and take configured number of items
    shuffled = shuffleArray(itemsWithBackdrops)
    if shuffled.count() > carouselItemCount
        m.mediaBarItems = shuffled.slice(0, carouselItemCount)
    else
        m.mediaBarItems = shuffled
    end if

    ' Initialize display if we have items
    if m.mediaBarItems.count() > 0
        createIndicatorDots()
        if m.mediaBarItems.count() > 1
            scene = m.top.getScene()
            sidebarActive = false
            if isValid(scene)
                sidebar = scene.findNode("sidebar")
                sidebarActive = isValid(sidebar) and sidebar.visible
            end if
            m.leftArrow.visible = not sidebarActive
            if isValid(m.leftArrowBg) then m.leftArrowBg.visible = not sidebarActive
            m.rightArrow.visible = true
            startAutoAdvanceTimer()
        end if
        ' Display first item (single backdrop update)
        displayMediaBarItem(0)
    end if
end sub

' Process item data into display format
function processItem(item as object) as object
    processed = {
        id: item.id,
        title: item.name,
        itemType: item.type,
        overview: invalid,
        year: invalid,
        rating: invalid,
        runtime: invalid,
        runtimeDisplay: "",
        communityRating: invalid,
        communityRatingDisplay: "",
        genres: [],
        genresDisplay: "",
        backdropUrl: "",
        logoUrl: ""
    }

    if isChainValid(item, "backdropImageTags") and item.backdropImageTags.count() > 0
        processed.backdropUrl = ImageURL(item.id, "Backdrop", {
            maxHeight: 1080,
            maxWidth: 1920,
            quality: 100,
            Tag: item.backdropImageTags[0]
        })
    end if

    if isChainValid(item, "imageTags.Logo")
        processed.logoUrl = ImageURL(item.id, "Logo", {
            maxHeight: 150,
            maxWidth: 500,
            quality: 100
        })
    end if

    ' Extract metadata
    if isValid(item.overview)
        processed.overview = item.overview
    end if

    if isValid(item.productionYear)
        processed.year = item.productionYear
    end if

    if isValid(item.officialRating)
        processed.rating = item.officialRating
    end if

    if isValid(item.runTimeTicks)
        minutes = int(item.runTimeTicks / 600000000)
        processed.runtime = minutes
        if minutes >= 60
            hours = int(minutes / 60)
            mins = minutes mod 60
            processed.runtimeDisplay = hours.toStr() + "h " + mins.toStr() + "m"
        else
            processed.runtimeDisplay = minutes.toStr() + " min"
        end if
    end if

    if isValid(item.communityRating)
        processed.communityRating = item.communityRating
        processed.communityRatingDisplay = formatFloat(item.communityRating, 1)
    end if

    if isChainValid(item, "genres") and item.genres.count() > 0
        processed.genres = item.genres
        ' Cache genres display string (first 3 genres joined)
        displayGenres = item.genres
        if displayGenres.count() > 3
            displayGenres = [displayGenres[0], displayGenres[1], displayGenres[2]]
        end if
        processed.genresDisplay = displayGenres.join(" â€¢ ")
    end if

    return processed
end function

' Create indicator dots for slides
sub createIndicatorDots()
    ' Clear existing dots
    m.indicatorDots.removeChildrenIndex(m.indicatorDots.getChildCount(), 0)

    totalItems = m.mediaBarItems.count()

    ' Show one dot for each item
    numDots = totalItems

    ' Create dot for each visible indicator
    for i = 0 to numDots - 1
        dot = createObject("roSGNode", "Poster")
        dot.uri = "pkg:/images/icons/circle.png"
        dot.width = 12
        dot.height = 12
        dot.loadDisplayMode = "scaleToFit"
        if i = 0
            ' Active dot is white
            dot.blendColor = "0xFFFFFFFF"
        else
            ' Inactive dot is gray
            dot.blendColor = "0xCECECEFF"
        end if
        dot.opacity = 1.0
        m.indicatorDots.appendChild(dot)
    end for

    ' Update dots background size
    updateDotsBackgroundSize()
end sub

' Update the background size for indicator dots
sub updateDotsBackgroundSize()
    if not isValid(m.indicatorDots) or not isValid(m.dotsBackground) then return

    numDots = m.indicatorDots.getChildCount()
    if numDots = 0 then return

    ' Calculate actual width based on dot sizes and spacing
    ' All dots are now 12px, spacing is 10px between dots
    ' Add padding: 20px on each side = 40px total

    dotSize = 12
    spacing = 10
    padding = 40

    totalDotsWidth = numDots * dotSize
    totalSpacingWidth = (numDots - 1) * spacing

    calculatedWidth = totalDotsWidth + totalSpacingWidth + padding
    m.dotsBackground.width = calculatedWidth

    ' Center the background and dots on screen
    ' Screen width is 1920, so center point is 960
    screenCenter = 960
    m.indicatorDots.translation = [screenCenter - (totalDotsWidth + totalSpacingWidth) / 2, 800]
    m.dotsBackground.translation = [screenCenter - calculatedWidth / 2, 792]
end sub

' Update indicator dots to show current slide
sub updateIndicatorDots()
    numDots = m.indicatorDots.getChildCount()
    if numDots = 0 then return

    ' Direct mapping - one dot per item
    activeDotIndex = m.currentIndex

    for i = 0 to numDots - 1
        dot = m.indicatorDots.getChild(i)
        if i = activeDotIndex
            ' Active dot - white
            dot.blendColor = "0xFFFFFFFF"
        else
            ' Inactive dot - gray
            dot.blendColor = "0xCECECEFF"
        end if
    end for
end sub

' Display media bar item with crossfade
sub displayMediaBarItem(index as integer)
    if index < 0 or index >= m.mediaBarItems.count() then return

    ' If this is not the first display and we have fade animations, do a crossfade
    if m.currentIndex <> index or m.pendingDisplayIndex >= 0
        if isValid(m.contentFadeOut) and isValid(m.infoOverlayContent) and m.infoOverlayContent.opacity > 0
            m.pendingDisplayIndex = index
            m.contentFadeOut.control = "start"
            ' Still update backdrop immediately so it crossfades in parallel
            item = m.mediaBarItems[index]
            if item.backdropUrl <> ""
                m.top.currentBackdrop = item.backdropUrl
            end if
            return
        end if
    end if

    showMediaBarItem(index)
end sub

' Called when contentFadeOut completes - swap content and fade back in
sub onContentFadeOutComplete(event as object)
    if event.getData() = "stopped" then return
    if m.pendingDisplayIndex >= 0
        showMediaBarItem(m.pendingDisplayIndex)
        m.pendingDisplayIndex = -1
        if isValid(m.contentFadeIn)
            ' Set dynamic fade-in targets to respect user settings
            if isValid(m.infoBgFadeInInterp)
                m.infoBgFadeInInterp.keyValue = [0.0, m.overlayOpacity ?? 0.5]
            end if
            if isValid(m.logoShadowFadeInInterp)
                m.logoShadowFadeInInterp.keyValue = [0.0, 0.6]
            end if
            m.contentFadeIn.control = "start"
        end if
    end if
end sub

' Actually populate the content (no animation, just sets values)
sub showMediaBarItem(index as integer)
    if index < 0 or index >= m.mediaBarItems.count() then return

    item = m.mediaBarItems[index]

    ' Update backdrop (single set, parent handles transitions)
    if item.backdropUrl <> ""
        m.top.currentBackdrop = item.backdropUrl
    end if

    ' Show logo OR title
    if item.logoUrl <> ""
        m.logoImage.uri = item.logoUrl
        m.logoShadow.uri = item.logoUrl
        m.logoImage.visible = true
        m.logoShadow.visible = true
        m.logoShadow.opacity = 0.6
        m.titleText.visible = false
    else
        m.titleText.text = item.title
        m.titleText.visible = true
        m.logoImage.visible = false
        m.logoShadow.visible = false
    end if

    ' Populate metadata with separators
    hasYear = false
    hasRating = false
    hasRuntime = false
    hasStarRating = false

    if item.year <> invalid
        m.yearLabel.text = item.year.toStr()
        hasYear = true
    else
        m.yearLabel.text = ""
    end if

    if item.rating <> invalid
        m.ratingLabel.text = item.rating
        hasRating = true
    else
        m.ratingLabel.text = ""
    end if

    if item.runtimeDisplay <> ""
        m.runtimeLabel.text = item.runtimeDisplay
        hasRuntime = true
    else
        m.runtimeLabel.text = ""
    end if

    ' Community rating with star
    if item.communityRatingDisplay <> ""
        m.starLabel.visible = true
        m.communityRatingLabel.text = item.communityRatingDisplay
        hasStarRating = true
    else
        m.starLabel.visible = false
        m.communityRatingLabel.text = ""
    end if

    ' Show/hide separator dots based on what metadata exists
    m.separatorDot1.visible = (hasYear and hasRating)
    m.separatorDot2.visible = (hasRating and hasRuntime)
    m.separatorDot3.visible = (hasRuntime and hasStarRating)

    ' Genres (use cached display string)
    hasGenres = (item.genresDisplay <> "")
    m.genresLabel.text = item.genresDisplay

    hasPreviousMeta = (hasYear or hasRating or hasRuntime or hasStarRating)
    m.separatorDot4.visible = (hasPreviousMeta and hasGenres)

    ' Overview (full text, no line limit)
    if item.overview <> invalid
        m.overviewLabel.text = item.overview
    else
        m.overviewLabel.text = ""
    end if

    ' Update indicator dots
    updateIndicatorDots()

    ' Update background size dynamically
    updateInfoBackgroundSize()
end sub

' Update info background to match content height
sub updateInfoBackgroundSize()
    if not isValid(m.infoOverlayContent) or not isValid(m.infoBackground) then return

    ' Get the bounding rect of the content
    contentHeight = m.infoOverlayContent.boundingRect().height

    if contentHeight > 0
        ' Add padding (15px top + 15px bottom = 30px total)
        m.infoBackground.height = contentHeight + 30
    end if
end sub

' Format float to string with decimals
function formatFloat(value as float, decimals as integer) as string
    multiplier = 10 ^ decimals
    rounded = int(value * multiplier + 0.5)
    intPart = int(rounded / multiplier)
    decPart = rounded mod multiplier

    result = intPart.toStr()
    if decimals > 0
        result = result + "." + decPart.toStr()
    end if

    return result
end function

' Start auto-advance timer
sub startAutoAdvanceTimer()
    if isValid(m.autoAdvanceTimer)
        m.autoAdvanceTimer.control = "stop"
        m.autoAdvanceTimer = invalid
    end if

    m.autoAdvanceTimer = createObject("roSGNode", "Timer")
    m.autoAdvanceTimer.duration = 7
    m.autoAdvanceTimer.repeat = true
    m.autoAdvanceTimer.observeFieldScoped("fire", "onAutoAdvance")
    m.autoAdvanceTimer.control = "start"
end sub

' Auto-advance handler
sub onAutoAdvance()
    if not m.isPaused and m.mediaBarItems.count() > 1
        nextSlide()
    end if
end sub

' Navigate to next slide
sub nextSlide()
    if m.mediaBarItems.count() <= 1 then return

    m.currentIndex = (m.currentIndex + 1) mod m.mediaBarItems.count()
    displayMediaBarItem(m.currentIndex)
end sub

' Navigate to previous slide
sub previousSlide()
    if m.mediaBarItems.count() <= 1 then return

    if m.currentIndex = 0
        m.currentIndex = m.mediaBarItems.count() - 1
    else
        m.currentIndex = m.currentIndex - 1
    end if

    displayMediaBarItem(m.currentIndex)
end sub

' Handle key events
function onKeyEvent(key as string, press as boolean) as boolean
    if not press then return false

    m.clearBackdrop = true ' Default to clearing backdrop on focus loss

    if key = KeyCode.UP
        ' Signal parent to navigate to overhang (navbar)
        ' and don't clear the backdrop (if any)
        m.clearBackdrop = false
        return false ' Let parent handle navigation to overhang
    else if key = KeyCode.DOWN
        ' Navigate down to home rows
        return false ' Let parent handle
    else if key = KeyCode.LEFT
        scene = m.top.getScene()
        if isValid(scene)
            sidebar = scene.findNode("sidebar")
            if isValid(sidebar) and sidebar.visible
                m.clearBackdrop = false
                sidebar.setFocus(true)
                return true
            end if
        end if
        previousSlide()
        ' Reset auto-advance timer
        if isValid(m.autoAdvanceTimer)
            m.autoAdvanceTimer.control = "stop"
            m.autoAdvanceTimer.control = "start"
        end if
        return true
    else if key = KeyCode.RIGHT
        nextSlide()
        ' Reset auto-advance timer
        if isValid(m.autoAdvanceTimer)
            m.autoAdvanceTimer.control = "stop"
            m.autoAdvanceTimer.control = "start"
        end if
        return true
    else if key = KeyCode.OK
        ' Navigate to item details
        if m.mediaBarItems.count() > 0 and m.currentIndex >= 0 and m.currentIndex < m.mediaBarItems.count()
            currentItem = m.mediaBarItems[m.currentIndex]
            if isValid(currentItem) and isValid(currentItem.id) and isValid(currentItem.itemType)
                itemNode = createObject("roSGNode", "ContentNode")
                itemNode.id = currentItem.id
                itemNode.title = currentItem.title
                itemNode.addFields({ type: currentItem.itemType })
                m.top.itemSelected = itemNode
            end if
        end if
        return true
    else if key = KeyCode.PLAY or key = "pause"
        ' Toggle pause/play
        m.isPaused = not m.isPaused
        m.pauseIndicator.visible = m.isPaused

        ' Stop/start auto-advance timer
        if isValid(m.autoAdvanceTimer)
            if m.isPaused
                m.autoAdvanceTimer.control = "stop"
            else
                m.autoAdvanceTimer.control = "start"
            end if
        end if
        return true
    end if

    return false
end function

' Public function to refresh the current display from parent
sub refreshCurrentDisplay()
    if m.mediaBarItems.count() > 0
        displayMediaBarItem(m.currentIndex)
    end if
end sub
